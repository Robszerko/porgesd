<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PÃ¶rgesd Fel!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark-blue: #1A237E;
            --bg-purple: #3F51B5;
            --bg-card: rgba(26, 35, 126, 0.6);
            --font-color-light: #E8EAF6;
            --font-color-dark: #1A237E;
            --accent-gold: #FFC107;
            --accent-pink: #E91E63;
            --accent-teal: #00BCD4;
            --pointer-red: #F44336;
            --tile-border-color: #5C6BC0;
            --special-prize-color: #B39DDB;
            --win-green: #66BB6A;
            --lose-red: #EF5350;
            --halver-orange: #FF8A65;
            --surprise-purple: #9575CD;
            --lotto-green: #4CAF50;
        }

        body {
            background-color: var(--bg-dark-blue);
            background-image: radial-gradient(circle at top right, var(--bg-purple) 0%, transparent 50%),
                              radial-gradient(circle at bottom left, var(--bg-purple) 0%, transparent 40%);
            font-family: 'Lato', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--font-color-light);
            text-rendering: optimizeLegibility;
            transition: background 0.5s ease;
            position: relative;
            overflow-x: hidden;
        }

        body.sunday-special {
             background-color: #1A237E;
             background-image:
                radial-gradient(ellipse at 80% 20%, rgba(255, 215, 0, 0.25) 0%, transparent 40%),
                radial-gradient(ellipse at 20% 80%, rgba(103, 58, 183, 0.4) 0%, transparent 50%),
                linear-gradient(160deg, #1A237E 0%, #311B92 100%);
        }

        body.sunday-special::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: transparent;
            box-shadow:
                -15vw 20vh 2px 1px #FFD700, 10vw 40vh 3px 1px #FFD700,
                30vw 90vh 2px 0px #FFD700, 50vw 10vh 2px 1px #FFD700,
                70vw 70vh 3px 1px #FFD700, 90vw 30vh 2px 1px #FFD700,
                -5vw 80vh 2px 0px #FFD700, 40vw 55vh 3px 0px #FFD700;
        }


        header {
            width: 100%;
            max-width: 1400px;
            padding-bottom: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        #logo-container {
            width: clamp(80px, 10vw, 120px);
            flex-shrink: 0;
            cursor: pointer;
        }

        #logo-svg {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
        }

        #game-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            color: var(--font-color-light);
            text-shadow: 2px 2px 0px var(--bg-dark-blue), 4px 4px 8px rgba(0,0,0,0.5);
        }

        #sunday-title {
            display: none;
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--accent-gold);
            text-shadow: 0 0 10px var(--accent-gold);
            margin-top: -15px;
            margin-bottom: 10px;
        }
        body.sunday-special #sunday-title {
            display: block;
        }

        #tv-container {
            width: 100%;
            max-width: 1400px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 25px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        #screen {
            background-color: rgba(18, 18, 18, 0.5);
            border-radius: 15px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
            width: 100%;
            padding: clamp(10px, 2vw, 20px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        #game-area {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            position: relative;
            z-index: 2;
        }

        #puzzle-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        #puzzle-category-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #lotto-bajnok-icon {
            font-size: 2rem;
            color: var(--lotto-green);
            text-shadow: 0 0 10px var(--lotto-green);
            display: none;
        }
        #puzzle-category {
            background: linear-gradient(145deg, var(--accent-pink), #AD1457);
            color: var(--font-color-light);
            padding: 10px 20px;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(1rem, 2vw, 1.5rem);
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3);
        }
        #puzzle-category.golden {
            background: linear-gradient(145deg, var(--accent-gold), #FF8F00);
            box-shadow: 0 0 20px var(--accent-gold);
            color: var(--font-color-dark);
        }
        
        #free-vowel-indicator {
            background-color: var(--win-green);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 5px;
            display: none;
            box-shadow: 0 0 10px var(--win-green);
        }

        #round-info-container {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--tile-border-color);
            border-radius: 8px;
            padding: 8px 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px 20px;
        }
        #round-display, #hour-block-display {
            font-size: 1rem;
            font-weight: 700;
            color: var(--font-color-light);
        }

        #copyright-notice {
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 8px;
            font-style: italic;
        }
        
        #auto-hints-container {
            width: 90%;
            max-width: 600px;
            text-align: center;
            font-size: 0.95rem;
            color: var(--accent-teal);
            margin-top: 15px;
            font-style: italic;
            line-height: 1.5;
            display: none;
            padding: 10px;
            background-color: rgba(0, 188, 212, 0.1);
            border: 1px solid var(--accent-teal);
            border-radius: 8px;
        }

        @keyframes hint-flash {
            0%, 100% { opacity: 1; transform: scale(1); }
            16%, 48%, 80% { opacity: 0.2; transform: scale(0.98); }
            32%, 64%, 96% { opacity: 1; transform: scale(1.02); }
        }

        .hint-appearing {
            animation: hint-flash 0.5s ease-in-out 3;
        }

        #puzzle-board {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            margin-top: auto;
            margin-bottom: auto;
        }
        .puzzle-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }
        .puzzle-tile {
            width: clamp(35px, 5.5vw, 50px);
            height: clamp(45px, 7vw, 65px);
            perspective: 1000px;
        }

        .tile-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .puzzle-tile.revealed .tile-inner {
            transform: rotateY(180deg);
        }

        .tile-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
        }

        .tile-front {
            background-color: rgba(0,0,0,0.2);
            border: 2px solid var(--tile-border-color);
        }

        @keyframes flash-effect {
            0%, 100% {
                box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
                border-color: var(--tile-border-color);
            }
            50% {
                box-shadow: 0 0 20px 8px var(--accent-teal);
                border-color: var(--accent-teal);
            }
        }
        .tile-front.flashing {
            animation: flash-effect 1.2s ease-in-out;
        }


        .tile-back {
            background-color: var(--font-color-light);
            color: var(--font-color-dark);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            transform: rotateY(180deg);
            text-shadow: 0 0 2px var(--accent-teal);
        }

        .puzzle-tile.space { background-color: transparent; border: none; }
        .puzzle-tile.space .tile-inner { display: none; }

        .puzzle-tile.special-char {
            background-color: var(--font-color-light); color: var(--font-color-dark);
            font-weight: 700; font-size: clamp(1.5rem, 4vw, 2.5rem); border-radius: 5px;
            display: flex; justify-content: center; align-items: center;
        }
        .puzzle-tile.special-char .tile-inner { display: none; }

        #alphabet-panel {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;
            background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;
            margin-top: auto;
        }
        .alphabet-key {
            width: 35px; height: 35px; font-family: 'Lato', sans-serif; font-weight: 700;
            font-size: 1rem; border: none; border-bottom: 3px solid rgba(0,0,0,0.4);
            border-radius: 5px; cursor: pointer; background-color: #C5CAE9;
            color: var(--font-color-dark); transition: all 0.1s ease;
        }
        .alphabet-key.vowel { background-color: var(--special-prize-color); }
        .alphabet-key:hover:not(:disabled) { background-color: var(--accent-gold); transform: translateY(-2px); }
        .alphabet-key:active:not(:disabled) { transform: translateY(1px); border-bottom-width: 1px; }
        .alphabet-key:disabled {
            background-color: #5C6BC0; color: #9FA8DA; cursor: not-allowed;
            opacity: 0.7; border-bottom: 3px solid #1A237E;
        }

        #game-controls-section {
            flex: 2; display: flex; flex-direction: column;
            justify-content: space-around; align-items: center; gap: 15px;
        }

        #player-info-wrapper, #game-interaction-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }


        #wheel-wrapper {
            position: relative; width: clamp(280px, 40vh, 380px); aspect-ratio: 1 / 1;
        }

        #wheel-pointer {
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 30px solid var(--pointer-red); position: absolute; top: -15px; left: 50%;
            transform: translateX(-50%); z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            border-radius: 3px; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        #wheel {
            width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.2, 0.8, 0.25, 1);
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4)); border-radius: 50%;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7);
        }

        #wheel-center-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: radial-gradient(circle, var(--bg-purple) 60%, var(--bg-dark-blue) 100%);
            color: var(--font-color-light);
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 1.1rem;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5), inset 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0;
        }
        #wheel-center-button:hover:not(:disabled) {
            background: radial-gradient(circle, #5C6BC0 60%, #303F9F 100%);
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.8), inset 0 0 10px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%) scale(1.05);
        }
        #wheel-center-button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #wheel-center-text {
            position: relative;
            z-index: 2;
        }
        #booster-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        #booster-svg circle {
            fill: none;
            stroke-width: 8;
        }
        #booster-svg .booster-bg {
            stroke: rgba(26, 35, 126, 0.7);
        }
        #booster-svg .booster-bar {
            stroke: var(--accent-gold);
            stroke-linecap: round;
        }

        @keyframes wheel-flash {
            0%, 100% { filter: brightness(1); }
            16%, 48%, 80% { filter: brightness(2.5) drop-shadow(0 0 8px white); }
            32%, 64%, 96% { filter: brightness(1); }
        }
        .flashing-segment { animation: wheel-flash 0.9s ease-in-out; }

        #all-huds-container {
             display: flex; flex-direction: row; justify-content: center;
             align-items: stretch; gap: 15px; flex-wrap: wrap;
             width: 100%; max-width: 750px; margin: 0 auto;
        }

        .player-hud {
            flex: 1; min-width: 180px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 5px;
            background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 10px;
            border: 1px solid var(--accent-gold); text-align: center;
            position: relative;
        }

        #lotto-prize-hud {
            border-color: var(--lotto-green);
            cursor: pointer;
        }
        #prize-chest-hud {
            border-color: #a97e41;
            cursor: pointer;
        }
        .prize-chest-svg {
            width: 24px;
            height: 24px;
        }
        
        #lotto-prize-count, #prize-chest-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--pointer-red);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .hud-label {
            font-size: clamp(0.9rem, 1.5vw, 1rem); color: var(--font-color-light);
            font-weight: 700; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;
        }
        #millionaire-icon { display: none; font-size: 1.5rem; animation: pulse 2s infinite; }
        body.millionaire-active #millionaire-icon { display: inline-block; }

        #score-display, #hourly-winnings-display, #round-winnings-display, #lotto-prize-label {
            font-family: 'Montserrat', sans-serif; font-size: clamp(1.6rem, 3vw, 2rem);
            color: var(--accent-gold); font-weight: 700;
            text-shadow: 0 0 8px var(--accent-gold); line-height: 1;
        }

        #round-winnings-display {
            color: var(--accent-teal); text-shadow: 0 0 8px var(--accent-teal);
        }
        
        #lotto-prize-label, #prize-chest-label {
            font-size: clamp(1rem, 2vw, 1.2rem); color: var(--lotto-green); text-shadow: 0 0 8px var(--lotto-green);
        }
        #prize-chest-label {
            color: #d4ac0d; text-shadow: 0 0 8px #d4ac0d;
        }

        #main-prize-progress {
            background-color: rgba(255, 193, 7, 0.1); border: 1px solid var(--accent-gold);
            color: #f4e9d8; padding: 8px; border-radius: 8px; width: 90%; max-width: 400px;
            text-align: center; font-size: 0.9rem; display: none;
        }
        #main-prize-progress strong { color: var(--accent-gold); }

        #won-prize-container {
            display: none; flex-direction: column; align-items: center; background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--special-prize-color); border-radius: 10px; padding: 8px 15px;
            margin-top: 10px; width: 90%; max-width: 350px; text-align: center;
        }
        #won-prize-container .prize-label { font-size: 0.8rem; text-transform: uppercase; color: #ddd; }
        #won-prize-container .prize-name {
            font-size: 1.1rem; font-weight: bold; color: var(--special-prize-color);
            text-shadow: 0 0 5px var(--special-prize-color);
        }

        .host-message-style {
            background: rgba(0,0,0,0.2); border: 1px solid var(--tile-border-color);
            color: white; padding: 10px; border-radius: 10px; min-height: 4em; text-align: center;
            font-size: clamp(0.9rem, 1.5vw, 1.1rem); display: flex; align-items: center;
            justify-content: center; width: 100%; max-width: 400px; transition: border-color 0.3s ease;
        }
        .host-message-style strong { color: var(--accent-gold); font-weight: 700; }
        .host-message-style a {
            color: var(--accent-teal); text-decoration: underline;
            font-weight: bold; cursor: pointer;
        }
        #host-message-desktop { display: none; }

        #power-meter-container { display: none; }

        #action-buttons {
            display: flex; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap;
        }
        .action-btn {
            padding: 12px 15px; font-family: 'Montserrat', sans-serif; font-weight: 700;
            font-size: clamp(0.8rem, 2vw, 1rem); border-radius: 8px; border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); cursor: pointer;
            transition: all 0.2s ease; text-transform: uppercase; flex-grow: 1; max-width: 150px;
        }
        .action-btn:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-2px); }
        .action-btn:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 2px 3px rgba(0,0,0,0.3); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #555 !important; color: #999 !important; }

        .solve-btn { background-color: var(--accent-gold); color: var(--font-color-dark); }
        .transfer-btn { background-color: var(--surprise-purple); color: white; }
        .lotto-btn { background-color: var(--lotto-green); color: white; }
        .nyero21-btn { background-color: var(--win-green); color: white; }

        #spin-button { display: none; }
        #solve-button { background-color: var(--accent-gold); color: var(--font-color-dark); }
        #transfer-button { background-color: var(--surprise-purple); color: white; }
        #lotto-button { background-color: var(--lotto-green); color: white; }
        #nyero21-button { background-color: var(--win-green); color: white; }
        #new-game-button { background-color: #78909C; color: white; margin-top: 10px; width: 100%; max-width: 480px;}
        #skip-error-btn { background-color: var(--pointer-red); color: white; margin-top: 10px; width: 100%; max-width: 480px; display: none; }

        #desktop-action-buttons { display: none; }

        #rules-container {
            background: var(--bg-card); color: var(--font-color-light);
            padding: 20px; margin-top: 20px; width: 100%; max-width: 1400px;
            border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        #rules-container h2 { font-family: 'Montserrat', sans-serif; color: var(--accent-gold); text-align: center; margin-top: 0; text-shadow: 0 0 8px var(--accent-gold); font-size: 2.2rem; }
        #rules-container ul { list-style-type: none; padding: 0; }
        #rules-container li { margin-bottom: 15px; padding-left: 35px; position: relative; line-height: 1.5; font-size: 1rem; }
        #rules-container li::before {
            content: 'ð¯';
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 1.5rem; position: absolute; left: 0; top: 0;
        }
        #rules-container li.gameplay::before { content: 'ð'; }
        #rules-container li.lotto::before { content: 'ðï¸'; }
        #rules-container li.dynamic-wheel::before { content: 'â¨'; }
        #rules-container li.minigame::before { content: 'ð'; }
        #rules-container li.prizes::before { content: 'ð'; }
        #rules-container li.week::before { content: 'ðï¸'; }
        #rules-container li.sunday::before { content: 'ð'; }
        #rules-container li.main-prize::before { content: 'ð'; }
        #rules-container li.millionaire::before { content: 'ð'; }
        #rules-container li.exit::before { content: 'ðª'; }
        #rules-container strong { color: var(--accent-gold); font-weight: 700; }
        #rules-container .sub-rule { font-size: 0.9em; color: #C5CAE9; margin-top: 8px; font-style: italic; }
        #rules-container .sub-rule ul { margin-top: 8px; }
        #rules-container .sub-rule li { font-size: 0.95em; margin-bottom: 5px; padding-left: 25px; }
        #rules-container .sub-rule li::before { content: 'ð¹'; font-size: 1rem; top: 4px;}


        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #303F9F; padding: 30px;
            border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 25px rgba(0,0,0,0.7); text-align: center;
            color: var(--font-color-light); width: 90%; max-width: 500px;
            transform: scale(0.9); transition: transform 0.3s ease;
            position: relative;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 {
            font-family: 'Montserrat', sans-serif; color: var(--accent-gold);
            margin-top: 0; font-size: 2rem; text-shadow: 0 0 8px var(--accent-gold);
        }
        .modal-content p { font-size: 1.1rem; margin-bottom: 20px; }
        .modal-input {
            width: 100%; padding: 10px; font-size: 1.2rem; border-radius: 5px;
            border: 2px solid var(--accent-gold); background: #1A237E;
            color: var(--font-color-light); box-sizing: border-box; margin-bottom: 20px;
            text-transform: uppercase;
        }
        .modal-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .modal-btn {
            padding: 12px 25px; font-family: 'Montserrat', sans-serif;
            font-weight: 700; font-size: 1rem; border-radius: 8px; border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); cursor: pointer;
            transition: all 0.2s ease; text-transform: uppercase;
        }
        .modal-btn.confirm { background-color: var(--accent-gold); color: var(--font-color-dark); }
        .modal-btn.cancel { background-color: #78909C; color: white; }
        
        #dev-modal .modal-content { max-width: 600px; }
        #dev-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dev-mode-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--pointer-red);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 10;
        }


        #main-prize-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; color: white; padding: 20px; box-sizing: border-box;
            backdrop-filter: blur(10px);
        }
        #main-prize-modal h2, #main-prize-modal h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--accent-gold); text-shadow: 0 0 15px var(--accent-gold); margin-bottom: 10px;
            position:relative; display: block; text-align: center;
        }
        #main-prize-title { font-size: clamp(2rem, 8vw, 4rem); }
        #main-prize-category { font-size: clamp(1.2rem, 4vw, 2rem); }
        #main-prize-board { margin-top: 20px; }
        #main-prize-board .puzzle-tile { width: clamp(40px, 6vw, 60px); height: clamp(50px, 8vw, 75px); }
        #main-prize-board .tile-back { font-size: clamp(2rem, 5vw, 3rem); }
        #main-prize-given-letters, #main-prize-final-answer { margin-top: 20px; font-size: 1.2rem; position:relative; display: block; text-align: center;}
        #main-prize-final-answer { color: var(--win-green); font-weight: bold; }
        #main-prize-timer {
            font-size: clamp(3rem, 12vw, 6rem); font-weight: 700;
            color: var(--accent-gold); margin: 10px 0; text-shadow: 0 0 10px var(--accent-gold);
            position:relative; display: block;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        #main-prize-timer.timer-low { color: var(--pointer-red); animation: pulse 0.5s infinite; text-shadow: 0 0 10px var(--pointer-red); }

        #main-prize-instructions {
            position: relative; display: block; min-height: 1.2em;
            margin-top: 15px;
            transition: color 0.3s ease;
        }
        #main-prize-alphabet-panel-container, #main-prize-solve-input, #main-prize-confirm-btn {
            position: relative; display: block;
        }
        #main-prize-solve-input { margin: 15px auto; display: block; }
        #main-prize-alphabet-panel-container { margin-top: 20px; }
        
        #nyero21-modal, #lotto-modal, #active-bonuses-modal, #prize-chest-modal { z-index: 1500; }
        #nyero21-modal .modal-content, #lotto-modal .modal-content, #active-bonuses-modal .modal-content, #prize-chest-modal .modal-content {
            max-width: 800px;
            background: transparent;
            border: none;
            box-shadow: none;
            overflow: visible;
        }
        #nyero21-content-wrapper, #lotto-content-wrapper, #bonuses-content-wrapper, #chest-content-wrapper {
            position: relative;
            padding: 30px;
            border-radius: 15px;
            background: #1A237E linear-gradient(180deg, rgba(63,81,181,0.5) 0%, rgba(26,35,126,0) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 25px rgba(0,0,0,0.7);
        }
        #nyero21-table-svg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 105%;
            height: 105%;
            z-index: -1;
        }
        #nyero21-joker {
            width: 150px;
            position: absolute;
            right: 0px;
            bottom: 0px;
            opacity: 0.4;
            transform: rotate(-15deg);
        }
        #nyero21-game-area { display: none; }
        #nyero21-info-bar {
            background-color: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: left;
            line-height: 1.6;
        }
        #nyero21-info-bar strong {
            color: var(--accent-gold);
            font-weight: 700;
        }
        #nyero21-card-deck {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            margin-bottom: 20px; perspective: 800px;
        }
        .nyero21-card {
            width: 70px; height: 100px; cursor: pointer; position: relative;
            transform-style: preserve-3d; transition: transform 0.5s;
        }
        .nyero21-card.flipped { transform: rotateY(180deg); cursor: default; }
        .nyero21-card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .nyero21-card-back {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-pink));
            border: 2px solid var(--font-color-light);
        }
        .nyero21-card-front {
            background-color: var(--font-color-light); transform: rotateY(180deg);
            display: flex; justify-content: center; align-items: center; font-size: 2.5rem;
            font-family: 'Montserrat', sans-serif; font-weight: 900; color: var(--font-color-dark);
        }
        #nyero21-player-hand { margin: 15px 0; }
        #nyero21-player-score {
            font-size: 4rem; color: var(--accent-gold); font-family: 'Montserrat';
            text-shadow: 0 0 10px var(--accent-gold);
        }
        #nyero21-result-message { font-size: 1.5rem; font-weight: bold; min-height: 2em; }
        #nyero21-result-message.win { color: var(--win-green); }
        #nyero21-result-message.lose { color: var(--lose-red); }

        /* LOTTO STYLES */
        #lotto-modal .modal-content { max-width: 600px; }
        #lotto-betting-area { position: relative; }
        #lotto-ticket-svg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
        }
        #lotto-ticket-content {
            padding: 20px;
        }
        #lotto-selected-display {
            font-size: 1.1rem;
            color: var(--font-color-dark);
            font-weight: bold;
            background-color: rgba(255,255,255,0.8);
            padding: 8px;
            border-radius: 5px;
            min-height: 1.5em;
            margin-bottom: 15px;
            text-shadow: none;
        }
        #lotto-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 8px; margin: 20px 0; }
        .lotto-number {
            width: 38px; height: 38px; display: flex; justify-content: center; align-items: center;
            background-color: #C5CAE9; color: var(--font-color-dark);
            border-radius: 50%; font-weight: bold; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .lotto-number:hover { background-color: var(--accent-gold); }
        .lotto-number.selected {
            background-color: var(--accent-pink); color: white; border-color: white;
            transform: scale(1.1); box-shadow: 0 0 10px var(--accent-pink);
        }
        .lotto-number.disabled { opacity: 0.6; cursor: not-allowed; background-color: #5C6BC0; }
        .lotto-drawing-container { margin-top: 20px; }
        .lotto-ball-wrapper { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 10px;}
        .lotto-ball {
            width: 50px; height: 50px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; font-family: 'Montserrat'; font-weight: 900; font-size: 1.5rem;
            background: radial-gradient(circle at 30% 30%, #fff, #ddd);
            color: #333; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.5);
        }
        .submitted-ticket-container { margin-top: 15px; background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        .submitted-ticket-header { font-weight: bold; text-transform: uppercase; color: var(--accent-teal); font-size: 0.9rem; }
        .submitted-ticket-numbers { display: flex; gap: 8px; justify-content: center; margin-top: 5px; }
        .submitted-ticket-number {
             width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
             background-color: #9FA8DA; font-weight: bold;
        }
        .submitted-ticket-number.match { background-color: var(--lotto-green); color: white; box-shadow: 0 0 10px var(--lotto-green); }
        #active-bonuses-list, #prize-chest-list { list-style-type: none; padding: 0; max-height: 40vh; overflow-y: auto;}
        #active-bonuses-list li, #prize-chest-list li { background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; }
        #prize-chest-list li { flex-direction: row; justify-content: space-between;}
        #prize-chest-list .prize-info { text-align: left;}

        .bonus-name { font-weight: bold; color: var(--lotto-green); font-size: 1.2rem;}
        .bonus-expiry, .prize-expiry { font-size: 0.8rem; color: #ccc; margin-top: 5px;}
        .activate-prize-btn {
            padding: 8px 12px; font-size: 0.8rem;
            background-color: var(--win-green); color: white;
            margin-left: 10px; flex-shrink: 0;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }

        /* Responsive Layout Switch */
        @media (max-width: 900px) {
            body { padding: 10px; }
            header { flex-direction: column; gap: 5px; }
            #game-title { font-size: clamp(2rem, 10vw, 3rem); }
            #tv-container { padding: 15px; border-radius: 15px; }
            #screen { padding: 10px; border-radius: 10px; gap: 15px; }
            #game-area { flex-direction: column; align-items: center; gap: 25px; }
            #puzzle-section, #game-controls-section { width: 100%; max-width: 450px; }
            #rules-container h2 { font-size: 1.8rem; } #rules-container li { font-size: 0.9rem; }
            #lotto-grid { gap: 5px; }
            .lotto-number { width: 32px; height: 32px; }
            #wheel-center-button { width: 70px; height: 70px; font-size: 0.9rem; }
            #booster-svg circle { stroke-width: 7; }

            #game-controls-section {
                display: flex;
                flex-direction: column;
            }

            #player-info-wrapper {
                order: 2;
                display: flex;
                flex-direction: column;
            }

            #game-interaction-wrapper { order: 1; }

            #all-huds-container { order: 2; margin-top: 15px; flex-direction: column; align-items: center; }
            .player-hud { width: 90%; max-width: 350px; }
            #main-prize-progress { order: 1; margin-bottom: 10px; }
            #won-prize-container { order: 3; }
        }

        @media (min-width: 901px) {
            #game-area { align-items: flex-end; }
            #player-info-wrapper { order: 1; }
            #game-interaction-wrapper { order: 2; }
            #puzzle-section { flex-direction: column; flex: 4; }

            #round-info-container { order: 1; margin: 0 auto 15px auto; width: auto; max-width: none; padding: 10px 30px; background-color: rgba(0,0,0,0.3); border-radius: 50px; border-width: 2px; }
            #puzzle-category-wrapper { order: 2; margin-bottom: 15px; }
            #puzzle-board { order: 3; margin-top: 0; margin-bottom: 0; }
            #auto-hints-container { order: 4; }
            #alphabet-panel { order: 5; margin: 25px auto 0 auto; width: 100%; max-width: 800px; }
            #desktop-action-buttons { order: 6; }
            #host-message-desktop { order: 7; }
            #free-vowel-indicator { order: 8; margin: 15px auto 0 auto; }
            #copyright-notice { order: 9; margin-top: 15px; }

            #puzzle-category { font-size: clamp(1.2rem, 1.8vw, 1.7rem); }
            .puzzle-tile { width: clamp(45px, 5vw, 60px); height: clamp(60px, 6.5vw, 75px); }
            .tile-back { font-size: clamp(2rem, 3.5vw, 3.2rem); }
            #alphabet-panel { gap: 8px; padding: 15px; }
            .alphabet-key { width: 45px; height: 45px; font-size: 1.3rem; border-radius: 8px; }
            
            #wheel-center-button { width: 90px; height: 90px; }
            #booster-svg circle { stroke-width: 9; }
            
            #desktop-action-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
                width: 100%;
                margin-top: 25px;
            }
            #desktop-action-buttons .action-btn {
                flex-grow: 0;
                flex-basis: 160px;
            }

            #host-message-desktop { margin: 20px auto 0 auto; }

            #host-message { display: none; }
            #host-message-desktop { display: flex; }
            
            #action-buttons {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div id="logo-container">
            <svg id="logo-svg" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="rimGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#E0E0E0"/>
                        <stop offset="50%" stop-color="#BDBDBD"/>
                        <stop offset="100%" stop-color="#9E9E9E"/>
                    </linearGradient>
                    <linearGradient id="bladeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                         <stop offset="0%" stop-color="#FFC107" />
                         <stop offset="100%" stop-color="#F44336" />
                    </linearGradient>
                     <filter id="logoGlow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="blur"/>
                        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.7 0" result="glow"/>
                        <feComposite in="glow" in2="SourceGraphic" operator="over"/>
                    </filter>
                </defs>

                <circle cx="50" cy="50" r="48" fill="#212121" />
                <circle cx="50" cy="50" r="42" fill="url(#rimGradient)" />
                <circle cx="50" cy="50" r="40" fill="#37474F" />

                <g filter="url(#logoGlow)">
                    <path id="blade" d="M 50 48 C 65 45, 75 30, 80 15 C 70 30, 60 43, 50 46 Z" fill="url(#bladeGradient)"/>
                    <use href="#blade" transform="rotate(72, 50, 50)" />
                    <use href="#blade" transform="rotate(144, 50, 50)" />
                    <use href="#blade" transform="rotate(216, 50, 50)" />
                    <use href="#blade" transform="rotate(288, 50, 50)" />
                </g>

                <circle cx="50" cy="50" r="18" fill="#424242" />
                <circle cx="50" cy="50" r="15" fill="#616161" />
                <circle cx="50" cy="50" r="5" fill="#FFC107" />
            </svg>
        </div>
        <h1 id="game-title">PÃ¶rgesd Fel!</h1>
        <h2 id="sunday-title">PrÃ©mium VasÃ¡rnap</h2>
    </header>
    <div id="tv-container">
        <div id="screen">
            <div id="game-area">
                <section id="puzzle-section">
                    <div id="puzzle-category-wrapper">
                        <div id="lotto-bajnok-icon">ð</div>
                        <div id="puzzle-category"></div>
                    </div>
                    <div id="free-vowel-indicator">Ingyen MagÃ¡nhangzÃ³d Van!</div>
                    <div id="round-info-container">
                        <div id="round-display"></div>
                        <div id="hour-block-display"></div>
                    </div>
                    <div id="copyright-notice">Â© Copyright by: Robi - PÃ¶rgesd Fel! Edition</div>
                    <div id="puzzle-board"></div>
                    <div id="auto-hints-container"></div>
                    <div id="alphabet-panel"></div>
                    <div id="desktop-action-buttons">
                        <button id="solve-button-desktop" class="action-btn solve-btn">Megfejtem</button>
                        <button id="transfer-button-desktop" class="action-btn transfer-btn">ÃtutalÃ¡s</button>
                        <button id="lotto-button-desktop" class="action-btn lotto-btn">Napi LottÃ³</button>
                        <button id="nyero21-button-desktop" class="action-btn nyero21-btn">NyerÅ21</button>
                    </div>
                    <div id="host-message-desktop" class="host-message-style"></div>
                </section>
                <section id="game-controls-section">
                    <div id="player-info-wrapper">
                        <div id="main-prize-progress"></div>
                        <div id="all-huds-container">
                            <div id="main-hud" class="player-hud">
                                <div class="hud-label"><span id="millionaire-icon">ð</span><span id="main-hud-label">Ãsszes Zseton</span></div>
                                <div id="score-display">0 Ft</div>
                            </div>
                            <div id="hourly-hud" class="player-hud">
                                <div class="hud-label">AktuÃ¡lis menet</div>
                                <div id="hourly-winnings-display">0 Ft</div>
                            </div>
                             <div id="round-winnings-hud" class="player-hud">
                                <div class="hud-label">Ebben a kÃ¶rben</div>
                                <div id="round-winnings-display">0 Ft</div>
                            </div>
                             <div id="lotto-prize-hud" class="player-hud" style="display: none;">
                                <div class="hud-label">âï¸ AktÃ­v BÃ³nuszok</div>
                                <div id="lotto-prize-label">MegtekintÃ©s</div>
                                <div id="lotto-prize-count">0</div>
                            </div>
                            <div id="prize-chest-hud" class="player-hud" style="display: none;">
                                <div class="hud-label">
                                   <svg class="prize-chest-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 8H4C2.89543 8 2 8.89543 2 10V18C2 19.1046 2.89543 20 4 20H20C21.1046 20 22 19.1046 22 18V10C22 8.89543 21.1046 8 20 8Z" fill="#a97e41"/>
                                    <path d="M20 8H4C2.89543 8 2 8.89543 2 10V18C2 19.1046 2.89543 20 4 20H20C21.1046 20 22 19.1046 22 18V10C22 8.89543 21.1046 8 20 8Z" stroke="#6e5127" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 8V6C16 4.89543 15.1046 4 14 4H10C8.89543 4 8 4.89543 8 6V8" stroke="#6e5127" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 12V16" stroke="#6e5127" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3 14H21" stroke="#d4ac0d" stroke-width="1.5"/>
                                    </svg>
                                    <span>NyeremÃ©nylÃ¡da</span>
                                </div>
                                <div id="prize-chest-label">MegtekintÃ©s</div>
                                <div id="prize-chest-count">0</div>
                            </div>
                        </div>
                        <div id="won-prize-container">
                            <div class="prize-label">Bezsebelt extra</div>
                            <div id="won-prize-name" class="prize-name"></div>
                        </div>
                    </div>
                    <div id="game-interaction-wrapper">
                        <div id="wheel-wrapper">
                            <button id="wheel-center-button">
                                <svg id="booster-svg" viewBox="0 0 100 100">
                                    <circle class="booster-bg" cx="50" cy="50" r="45"></circle>
                                    <circle class="booster-bar" cx="50" cy="50" r="45" transform="rotate(-90 50 50)"></circle>
                                </svg>
                                <span id="wheel-center-text">PÃ¶rget</span>
                            </button>
                            <div id="wheel-pointer"></div>
                            <svg id="wheel" viewBox="0 0 100 100"></svg>
                        </div>
                        <div id="power-meter-container">
                            <div id="power-meter-bar"></div>
                        </div>
                        <div id="host-message" class="host-message-style">HellÃ³ a stÃºdiÃ³ban! KezdÃ©shez kÃ¼ldj meg egy pÃ¶rgetÃ©st!</div>
                        <div id="action-buttons">
                            <button id="spin-button" class="action-btn">PÃ¶rgetÃ©s</button>
                            <button id="solve-button" class="action-btn solve-btn">Megfejtem</button>
                            <button id="transfer-button" class="action-btn transfer-btn">ÃtutalÃ¡s</button>
                            <button id="lotto-button" class="action-btn lotto-btn">Napi LottÃ³</button>
                            <button id="nyero21-button" class="action-btn nyero21-btn">NyerÅ21</button>
                            <button id="new-game-button" class="action-btn">Ãj JÃ¡tÃ©k</button>
                            <button id="skip-error-btn" class="action-btn">Hiba ÃtugrÃ¡sa</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="rules-container">
        <h2>JÃ¡tÃ©kszabÃ¡lyok</h2>
        <ul>
            <li class="goal"><strong>CÃ©l:</strong> GyÅ±jtsd a legtÃ¶bb zsetont a feladvÃ¡nyok megfejtÃ©sÃ©vel! PÃ¶rgess a szerencsekerÃ©ken, tippelj betÅ±ket, Ã©s fejtsd meg a rejtvÃ©nyt, mielÅtt csÅdbe mÃ©sz!</li>
            <li class="gameplay"><strong>JÃ¡tÃ©kmenet:</strong> Minden Ã³rÃ¡ban 10, egyre nehezedÅ feladvÃ¡ny vÃ¡r. PÃ¶rgess a kerÃ©ken, ami meghatÃ¡rozza a kÃ¶vetkezÅ mÃ¡ssalhangzÃ³-tipped Ã©rtÃ©kÃ©t. Ha a betÅ± szerepel a tÃ¡blÃ¡n, annyiszor kapod meg a pÃ¶rgetett Ã¶sszeget, ahÃ¡nyszor a betÅ± elÅfordul. A kÃ¶rben gyÅ±jtÃ¶tt zsetonjaidbÃ³l vÃ¡sÃ¡rolhatsz magÃ¡nhangzÃ³t (az Ã¡ruk egyre nÅ), vagy megkÃ­sÃ©relheted a megfejtÃ©st, amiÃ©rt extra bÃ³nusz zseton jÃ¡r.</li>
            <li class="lotto"><strong>Napi LottÃ³:</strong> Minden nap este 7-ig vÃ¡sÃ¡rolhatsz lottÃ³szelvÃ©nyt a megnyert zsetonjaidbÃ³l. Adj meg <strong>5 szÃ¡mot a 45-bÅl!</strong> A sorsolÃ¡s minden este 7-kor tÃ¶rtÃ©nik. A nyeremÃ©nyek a talÃ¡latok szÃ¡mÃ¡tÃ³l fÃ¼ggnek, Ã©s a NyeremÃ©nylÃ¡dÃ¡dba kerÃ¼lnek, ahonnan aktivÃ¡lhatod Åket. A nyeremÃ©nyek lehetnek tÃ¶bb napig vagy akÃ¡r a hÃ©t vÃ©gÃ©ig tartÃ³ bÃ³nuszok, mint pÃ©ldÃ¡ul CSÅD-vÃ©delem, dupla pÃ©nz, vagy a fÅnyeremÃ©ny, a LottÃ³Bajnok cÃ­m!</li>
            <li class="dynamic-wheel"><strong>Dinamikus KerÃ©k:</strong> A kerÃ©k tartalma minden fordulÃ³ban vÃ¡ltozhat! Ahogy haladsz elÅre, egyre nagyobb nyeremÃ©nyek, de Ãºj mezÅk is megjelennek. Ilyenek pÃ©ldÃ¡ul a <strong>CSÅD</strong> (elveszti a kÃ¶rÃ¶s pÃ©nzed), <strong>FelezÅ</strong> (felezi a kÃ¶rÃ¶s pÃ©nzed), <strong>Dupla vagy Semmi</strong> (kockÃ¡ztathatod a kÃ¶rÃ¶s pÃ©nzed egy betÅ±tippel), <strong>KÃ¼lÃ¶ndÃ­j</strong> (Ã©rtÃ©kes tÃ¡rgynyeremÃ©ny vagy annak pÃ©nzbeli megfelelÅje), Ã©s a <strong>MeglepetÃ©s</strong> (egy vÃ©letlenszerÅ± pozitÃ­v vagy negatÃ­v esemÃ©ny).</li>
            <li class="minigame"><strong>NyerÅ21 MinijÃ¡tÃ©k:</strong> Ha Ã©pp nem te pÃ¶rgetsz, vagy csak egy kis extra izgalomra vÃ¡gysz, prÃ³bÃ¡ld ki a NyerÅ21-et! TegyÃ©l fel a zsetonjaidbÃ³l, Ã©s hÃºzz lapokat egy 10 lapos (2-11 Ã©rtÃ©kÅ±) paklibÃ³l. Ha a lapjaid Ã¶sszege elÃ©ri a 21-et, a tÃ©ted Ã¶tszÃ¶rÃ¶sÃ©t nyered! Ha az Ã¶sszeg 18 Ã©s 20 kÃ¶zÃ¶tt van, a tÃ©ted duplÃ¡ja jÃ¡r vissza. De vigyÃ¡zz, ha tÃºllÃ©ped a 21-et, a tÃ©t elvÃ©sz! ÃrÃ¡nkÃ©nt korlÃ¡tozott szÃ¡mban jÃ¡tszhatsz.</li>
            <li class="prizes"><strong>BÃ³nuszok Ã©s NyeremÃ©nyek:</strong> A jÃ¡tÃ©k sorÃ¡n tÃ¶bbfÃ©le bÃ³nuszt szerezhetsz. A LottÃ³n nyert jutalmak a <strong>NyeremÃ©nylÃ¡dÃ¡ba</strong> kerÃ¼lnek, ahonnan manuÃ¡lisan kell aktivÃ¡lnod Åket. Az aktivÃ¡lt bÃ³nuszok egy ideig (pl. 24 Ã³rÃ¡ig vagy a hÃ©t vÃ©gÃ©ig) extra elÅnyÃ¶ket adnak. A kerÃ©ken pÃ¶rgethetÅ <strong>KÃ¼lÃ¶ndÃ­j</strong> pedig egy azonnali vÃ¡lasztÃ¡si lehetÅsÃ©get kÃ­nÃ¡l egy Ã©rtÃ©kes tÃ¡rgy Ã©s a kÃ©szpÃ©nz kÃ¶zÃ¶tt.</li>
            <li class="week"><strong>Heti Kassza:</strong> Minden, amit hÃ©tkÃ¶znap (hÃ©tfÅtÅl szombatig) nyersz, a Heti KasszÃ¡dba kerÃ¼l. Ezt a pÃ©nzt vasÃ¡rnap teszed kockÃ¡ra.</li>
            <li class="sunday"><strong>PrÃ©mium VasÃ¡rnap:</strong> VasÃ¡rnap a Heti KasszÃ¡dbÃ³l tett tÃ©tekkel jÃ¡tszsol. Minden vasÃ¡rnapi feladvÃ¡ny elÅtt a Heti KasszÃ¡dbÃ³l kell tÃ©tet megtenned. A cÃ©l, hogy a nap vÃ©gÃ©re minÃ©l tÃ¶bbet gyÅ±jts Ã©s elnyerd a <strong>HÃ©t Milliomosa</strong> cÃ­met!</li>
            <li class="main-prize"><strong>FÅdÃ­j JÃ¡tÃ©k:</strong> Ha egy Ã³rÃ¡s jÃ¡tÃ©kblokk vÃ©gÃ©re (a 10. feladvÃ¡ny utÃ¡n) legalÃ¡bb 150.000 Ft-ot gyÅ±jtÃ¶ttÃ©l az adott Ã³rÃ¡ban, esÃ©lyt kapsz a FÅdÃ­j JÃ¡tÃ©kra! Itt az Ã³ra alatt gyÅ±jtÃ¶tt teljes pÃ©nzedet kockÃ¡ztatva, egyetlen fÅdÃ­j-feladvÃ¡ny megfejtÃ©sÃ©vel megduplÃ¡zhatod azt! A jÃ¡tÃ©khoz ki kell vÃ¡lasztanod 5 mÃ¡ssalhangzÃ³t Ã©s 1 magÃ¡nhangzÃ³t, majd 30 mÃ¡sodperced van a megfejtÃ©sre. Ha nem gyÅ±lt Ã¶ssze a limit, de a teljes vagyonodbÃ³l ki tudod pÃ³tolni a hiÃ¡nyzÃ³ Ã¶sszeget, akkor is jÃ¡tszhatsz.</li>
            <li class="millionaire"><strong>A HÃ©t Milliomosa:</strong> Az a jÃ¡tÃ©kos, aki a vasÃ¡rnapi jÃ¡tÃ©k vÃ©gÃ©re a legmagasabb egyenleggel zÃ¡r (minimum 1.000.000 Ft felett), elnyeri "A HÃ©t Milliomosa" cÃ­met. Ez a cÃ­m a teljes kÃ¶vetkezÅ hÃ©tre exkluzÃ­v bÃ³nuszokat Ã©s elÅnyÃ¶ket biztosÃ­t szÃ¡mÃ¡ra a jÃ¡tÃ©kban.</li>
            <li class="exit"><strong>KilÃ©pÃ©s:</strong> Ha egy Ã³rÃ¡n belÃ¼l kilÃ©psz a jÃ¡tÃ©kbÃ³l, majd visszatÃ©rsz, a mÃ¡sodik kilÃ©pÃ©snÃ©l az adott Ã³rÃ¡ban szerzett Ã¶sszes nyeremÃ©nyed elvÃ©sz. Gondold meg jÃ³l!</li>
        </ul>
    </div>


    <!-- ModÃ¡lis ablakok -->

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="custom-modal-title">MegfejtÃ©s</h3>
            <p id="custom-modal-text">Na, mi a megfejtÃ©s?</p>
            <input id="solve-input" type="text" class="modal-input" placeholder="ÃRD BE A MEGFEJTÃST...">
            <div class="modal-buttons" id="custom-modal-buttons"></div>
        </div>
    </div>
    
    <div id="dev-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>FejlesztÅi MenÃ¼</h3>
            <div id="dev-options">
                <button id="dev-force-main-prize" class="modal-btn confirm">FÅdÃ­j JÃ¡tÃ©k Teszt</button>
                <button id="dev-test-lotto" class="modal-btn lotto-btn">Napi LottÃ³ Teszt</button>
                <button id="dev-test-nyero21" class="modal-btn nyero21-btn">NyerÅ21 Teszt</button>
            </div>
            <div class="modal-buttons">
                 <button id="dev-modal-close-btn" class="modal-btn cancel">BezÃ¡rÃ¡s</button>
            </div>
        </div>
    </div>
    
    <div id="main-prize-modal">
         <span class="dev-mode-indicator" style="display: none;">TESZT MÃD</span>
         <h2 id="main-prize-title">FÅdÃ­j JÃ¡tÃ©k</h2>
         <h3 id="main-prize-category">FÅdÃ­j KategÃ³ria</h3>
         <div id="main-prize-board"></div>
         <p id="main-prize-given-letters"></p>
         <p id="main-prize-final-answer" style="display: none;"></p>
         <div id="main-prize-timer">30.0</div>
         <p id="main-prize-instructions">Ãrd be a megfejtÃ©st, mielÅtt lejÃ¡r az idÅ!</p>
         <div id="main-prize-alphabet-panel-container"></div>
         <input id="main-prize-solve-input" type="text" class="modal-input" placeholder="MEGFEJTÃS">
         <div class="modal-buttons">
            <button id="main-prize-select-confirm-btn" class="modal-btn confirm">BetÅ±k lezÃ¡rÃ¡sa</button>
            <button id="main-prize-confirm-btn" class="modal-btn confirm">Megfejtem!</button>
            <button id="main-prize-close-btn" class="modal-btn cancel" style="display: none;">BezÃ¡rÃ¡s</button>
         </div>
    </div>

    <div id="nyero21-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="nyero21-content-wrapper">
                 <span class="dev-mode-indicator" style="display: none;">TESZT MÃD</span>
                 <svg id="nyero21-table-svg" viewBox="0 0 200 120" preserveAspectRatio="none">
                    <defs>
                        <radialGradient id="tableGrad" cx="50%" cy="50%" r="70%" fx="50%" fy="50%">
                            <stop offset="0%" style="stop-color:rgb(0,80,0);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:rgb(0,40,0);stop-opacity:1" />
                        </radialGradient>
                    </defs>
                    <ellipse cx="100" cy="60" rx="100" ry="60" fill="url(#tableGrad)"/>
                    <path d="M 10 60 Q 100 -10 190 60" stroke="#a97e41" stroke-width="5" fill="none" />
                </svg>
                <img id="nyero21-joker" src="https://assets.codepen.io/1506195/joker-card.svg" alt="Joker">
                <h3 style="color:white;">NyerÅ21</h3>
                <div id="nyero21-staking-area">
                    <p>Tedd meg a tÃ©tet a NyerÅ21 jÃ¡tÃ©khoz! A cÃ©l 21-et elÃ©rni, de nem tÃºllÃ©pni. A 21-es lapÃ©rt a tÃ©t 5x-Ã¶se, 18-20-ig a tÃ©t duplÃ¡ja jÃ¡r vissza.</p>
                    <p>Jelenlegi egyenleg: <strong id="nyero21-player-balance">0 Ft</strong></p>
                    <p id="nyero21-plays-left"></p>
                    <input id="nyero21-stake-input" type="number" class="modal-input" placeholder="TÃ©t Ã¶sszege">
                    <div class="modal-buttons">
                        <button id="nyero21-start-game-btn" class="modal-btn confirm">JÃ¡tÃ©k indÃ­tÃ¡sa</button>
                        <button id="nyero21-cancel-btn" class="modal-btn cancel">MÃ©gse</button>
                    </div>
                </div>
                <div id="nyero21-game-area">
                    <div id="nyero21-info-bar"></div>
                    <div id="nyero21-card-deck"></div>
                    <div id="nyero21-player-hand">
                        <p>PontszÃ¡mod:</p>
                        <div id="nyero21-player-score">0</div>
                    </div>
                    <div id="nyero21-result-message"></div>
                    <div class="modal-buttons">
                         <button id="nyero21-hit-btn" class="modal-btn confirm">Lapok kÃ¶zÃ¼l vÃ¡lasztok</button>
                         <button id="nyero21-stand-btn" class="modal-btn" style="background-color: var(--accent-teal); color: white;">MegÃ¡llok</button>
                         <button id="nyero21-new-game-btn" class="modal-btn confirm">Ãj JÃ¡tÃ©k</button>
                         <button id="nyero21-close-btn" class="modal-btn cancel">BezÃ¡rÃ¡s</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="lotto-modal" class="modal-overlay">
        <div class="modal-content">
             <div id="lotto-content-wrapper">
                 <span class="dev-mode-indicator" style="display: none;">TESZT MÃD</span>
                 <h3 id="lotto-title">Napi LottÃ³</h3>
                 <div id="lotto-info-area">
                    <p id="lotto-status-text"></p>
                    <div id="lotto-drawing-container">
                        <p id="lotto-drawing-date"></p>
                        <div id="lotto-winning-numbers" class="lotto-ball-wrapper"></div>
                    </div>
                    <div id="lotto-submitted-tickets"></div>
                     <div class="modal-buttons">
                        <button id="lotto-buy-ticket-btn" class="modal-btn lotto-btn">Ãj szelvÃ©ny</button>
                        <button id="lotto-cancel-btn" class="modal-btn cancel">BezÃ¡rÃ¡s</button>
                    </div>
                 </div>
                 <div id="lotto-betting-area" style="display: none;">
                    <svg id="lotto-ticket-svg" viewBox="0 0 100 150" preserveAspectRatio="none"><path d="M0 5 Q 0 0 5 0 H95 Q 100 0 100 5 V145 Q 100 150 95 150 H5 Q 0 150 0 145 V5 Z" fill="#E8EAF6" stroke="#BDBDBD" stroke-width="0.5"></path><path d="M0 40 L100 40 M20 0 V40 M80 0 V40" stroke="#CFD8DC" stroke-width="0.5" stroke-dasharray="2"></path></svg>
                    <div id="lotto-ticket-content">
                        <p>VÃ¡lassz ki 5 szÃ¡mot a 45-bÅl! <br><span id="lotto-cost-text">A szelvÃ©ny Ã¡ra: <strong>5.000 Ft</strong></span></p>
                        <div id="lotto-selected-display">NyerÅszÃ¡maid: -</div>
                        <div id="lotto-grid"></div>
                        <div class="modal-buttons">
                            <button id="lotto-submit-btn" class="modal-btn confirm" disabled>SzelvÃ©ny feladÃ¡sa</button>
                            <button id="lotto-cancel-bet-btn" class="modal-btn cancel">Vissza</button>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="active-bonuses-modal" class="modal-overlay">
         <div class="modal-content">
             <div id="bonuses-content-wrapper">
                 <h3>AktÃ­v BÃ³nuszok</h3>
                 <ul id="active-bonuses-list"></ul>
                 <div class="modal-buttons">
                    <button id="active-bonuses-close-btn" class="modal-btn cancel">BezÃ¡rÃ¡s</button>
                 </div>
             </div>
        </div>
    </div>
    
    <div id="prize-chest-modal" class="modal-overlay">
        <div class="modal-content">
             <div id="chest-content-wrapper">
                 <h3>NyeremÃ©nylÃ¡da</h3>
                 <p>Itt talÃ¡lod a lottÃ³n vagy mÃ¡s mÃ³don nyert, aktivÃ¡lÃ¡sra vÃ¡rÃ³ bÃ³nuszaidat.</p>
                 <ul id="prize-chest-list"></ul>
                 <div class="modal-buttons">
                    <button id="prize-chest-close-btn" class="modal-btn cancel">BezÃ¡rÃ¡s</button>
                 </div>
             </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
          const allPuzzles = [
  
    { "category": "FÃ¶ldrajz", "puzzle": "A DUNA-DELTA", "hints": ["A Duna Fekete-tengeri torkolatvidÃ©ke.", "A VilÃ¡gÃ¶rÃ¶ksÃ©g rÃ©sze."] },
    { "category": "Sorozat", "puzzle": "BREAKING BAD - TOTÃL SZÃVÃS", "hints": ["Egy kÃ©miatanÃ¡rrÃ³l szÃ³l, aki drogfÅzÃ©sre adja a fejÃ©t.", "Walter White Ã¡talakulÃ¡sa a kÃ¶zponti tÃ©ma."] },
    { "category": "SportÃ¡g", "puzzle": "CSELGÃNCS (JUDO)", "hints": ["JapÃ¡n eredetÅ± kÃ¼zdÅsport.", "'A lÃ¡gy Ãºt' a jelentÃ©se."] },
    
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "ADDIG JÃR A KORSÃ A KÃTRA MÃG EL NEM TÃRIK", hint: "KÃ¶zmondÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "NEM MIND ARANY AMI FÃNYLIK", hint: "KÃ¶zmondÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "JOBB FÃLNI MINT MEGIJEDNI", hint: "KÃ¶zmondÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "AKI MÃSNAK VERMET ÃS MAGA ESIK BELE", hint: "KÃ¶zmondÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "KICSI A BORS DE ERÅS", hint: "SzÃ³lÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "AJÃNDÃK LÃNAK NE NÃZD A FOGÃT", hint: "KÃ¶zmondÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "SOK LÃD DISZNÃT GYÅZ", hint: "KÃ¶zmondÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "BAGOLY MONDJA VERÃBNEK HOGY NAGYFEJÅ°", hint: "SzÃ³lÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "RELATIVITÃSELMÃLET", hint: "TudomÃ¡nyos elmÃ©let" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "DEZOXIRIBONUKLEINSAV", hint: "BiolÃ³giai szakkifejezÃ©s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "FOTOSZINTÃZIS", hint: "BiolÃ³giai folyamat" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "NAGY HADRONÃTKÃZTETÅ", hint: "TudomÃ¡nyos lÃ©tesÃ­tmÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "GRAVITÃCIÃS HULLÃMOK", hint: "Fizikai jelensÃ©g" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "MESTERSÃGES INTELLIGENCIA", hint: "TechnolÃ³giai fogalom" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "KVANTUMSZÃMÃTÃGÃP", hint: "TechnolÃ³giai eszkÃ¶z" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "PERIÃDUSOS RENDSZER", hint: "KÃ©miai fogalom" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "HÃBORÃ ÃS BÃKE", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A NYOMORULTAK", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "BÅ°N ÃS BÅ°NHÅDÃS", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "SZÃZ ÃV MAGÃNY", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "AZ ISTENI SZÃNJÃTÃK", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "DON QUIJOTE DE LA MANCHA", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "MOBY DICK A FEHÃR BÃLNA", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A LEGYEK URA", hint: "Irodalmi mÅ±" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "AMAZONASI ESÅERDÅ", hint: "FÃ¶ldrajzi hely" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "MARIANNA-ÃROK", hint: "FÃ¶ldrajzi hely" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "NAGY-KORALLZÃTONY", hint: "FÃ¶ldrajzi hely" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "SZAHARA SIVATAG", hint: "FÃ¶ldrajzi hely" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "GALÃPAGOS-SZIGETEK", hint: "FÃ¶ldrajzi hely" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "AURORA BOREALIS", hint: "TermÃ©szeti jelensÃ©g" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "VIKTÃRIA-VÃZESÃS", hint: "FÃ¶ldrajzi hely" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "CSENDES-ÃCEÃNI TÅ°ZGYÅ°RÅ°", hint: "FÃ¶ldrajzi jelensÃ©g" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A NORMANDIAI PARTRSZÃLLÃS", hint: "TÃ¶rtÃ©nelmi esemÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A BERLINI FAL LEOMBLÃSA", hint: "TÃ¶rtÃ©nelmi esemÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A NAGY FRANCIA FORRADALOM", hint: "TÃ¶rtÃ©nelmi esemÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A RÃMAI BIRODALOM BUKÃSA", hint: "TÃ¶rtÃ©nelmi esemÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A REFORMÃCIÃ KEZDETE", hint: "TÃ¶rtÃ©nelmi esemÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A TIZENHÃROM GYARMAT FÃGGETLENSÃGE", hint: "TÃ¶rtÃ©nelmi esemÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A SZIKSZTUSZI KÃPOLNA MENNYEZETE", hint: "MÅ±alkotÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "LEONARDO DA VINCI MONA LISA", hint: "MÅ±alkotÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "PÃRIZSI NOTRE-DAME SZÃKESEGYHÃZ", hint: "ÃpÃ¼let" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "AZ UTOLSÃ VACSORA", hint: "MÅ±alkotÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A GUERNICA FESTMÃNY PABLO PICASSO", hint: "MÅ±alkotÃ¡s" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A VELENCEI KARNEVÃL", hint: "KulturÃ¡lis esemÃ©ny" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "JAPÃN CSERESZNYEVIRÃGZÃS", hint: "TermÃ©szeti jelensÃ©g" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A CSILLAGOK HÃBORÃJA BALJÃS ÃRNYAK", hint: "FilmcÃ­m" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "A GYÅ°RÅ°K URA A KIRÃLY VISSZATÃR", hint: "FilmcÃ­m" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "APOKALIPSZIS MOST", hint: "FilmcÃ­m" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "BOHEMIAN RHAPSODY A QUEEN EGYÃTTES", hint: "Zenei mÅ± / FilmcÃ­m" },
    { category: "FÅdÃ­j FeladvÃ¡ny", puzzle: "WOLFGANG AMADEUS MOZART", hint: "HÃ­res szemÃ©ly" },
            ];

            

           const SPECIAL_PRIZES = [
                { name: 'Ãves elÅfizetÃ©s egy hÃ­rportÃ¡lra', value: 25000 }, { name: 'Elektromos roller', value: 120000 },
                { name: 'KÃ©t VIP jegy egy koncertre', value: 50000 }, { name: 'Egy rekesz kÃ©zmÅ±ves sÃ¶r', value: 20000 },
                { name: 'Egy Ã©vre elegendÅ Ã¼dÃ­tÅ', value: 40000 }, { name: 'BÃ©rlet egy nyÃ¡ri fesztivÃ¡lra', value: 150000 },
                 { name: 'Egy hÃ©tvÃ©ge egy wellness hotelben', value: 130000 },
                { name: 'Profi drÃ³n', value: 180000 },
                { name: 'Okosotthon csomag', value: 250000 },
                { name: 'Gamer laptop', value: 500000 },
                { name: 'NagykÃ©pernyÅs 4K TV', value: 350000 },
                { name: 'Luxus karÃ³ra', value: 450000 },
                { name: 'HÅlÃ©gballonos utazÃ¡s', value: 380000 },
            ];
            
            const wheelSegmentsR1 = [
                { label: '300', value: 300, color: '#4DB6AC' }, { label: 'CSÅD', value: 'bankrupt', color: '#37474F' },
                { label: '500', value: 500, color: '#F06292' }, { label: '450', value: 450, color: '#7E57C2' },
                { label: 'KIMARADSZ', value: 'lose_turn', color: '#78909C' }, { label: '400', value: 400, color: '#FFB74D' },
                { label: '600', value: 600, color: '#E91E63' }, { label: '+1000', value: 1000, color: '#42A5F5', isBonus: true },
                { label: 'DUPLA/SEMMI', value: 'double_or_nothing', color: '#5C6BC0'}, { label: '700', value: 700, color: '#26C6DA' },
                { label: '550', value: 550, color: '#9CCC65' }, { label: '1000', value: 1000, color: '#FFCA28' }
            ];
            const wheelSegmentsR2 = [
                { label: '600', value: 600, color: '#4DB6AC' }, { label: 'CSÅD', value: 'bankrupt', color: '#37474F' },
                { label: '800', value: 800, color: '#F06292' }, { label: '1000', value: 1000, color: '#7E57C2' },
                { label: 'KIMARADSZ', value: 'lose_turn', color: '#78909C' }, { label: 'KÃLÃNDÃJ', value: 'special_prize', color: '#B39DDB' },
                { label: '700', value: 700, color: '#FFB74D' }, { label: '+2500', value: 2500, color: '#42A5F5', isBonus: true },
                { label: 'DUPLA/SEMMI', value: 'double_or_nothing', color: '#5C6BC0'}, { label: '900', value: 900, color: '#E91E63' },
                { label: '1200', value: 1200, color: '#9CCC65' }, { label: '2000', value: 2000, color: '#FFCA28' }
            ];
            const wheelSegmentsR3 = [
                { label: '1000', value: 1000, color: '#4DB6AC' }, { label: 'CSÅD', value: 'bankrupt', color: '#37474F' },
                { label: '1500', value: 1500, color: '#F06292' }, { label: 'DUPLA/SEMMI', value: 'double_or_nothing', color: '#7E57C2' },
                { label: '2500', value: 2500, color: '#78909C' }, { label: 'KÃLÃNDÃJ', value: 'special_prize', color: '#B39DDB' },
                { label: '2000', value: 2000, color: '#FFB74D' }, { label: '1200', value: 1200, color: '#E91E63' },
                { label: '1800', value: 1800, color: '#9CCC65' }, { label: '+5000', value: 5000, color: '#42A5F5', isBonus: true },
                { label: '3000', value: 3000, color: '#D4E157' }, { label: '5000', value: 5000, color: '#FFEE58' }
            ];
            
            const PUZZLES_PER_HOUR = 10;
            const VOWELS = "AÃEÃIÃOÃÃÅUÃÃÅ°";
            const FULL_ALPHABET = "AÃBCDEÃFGHIÃJKLMNOÃÃÅPQRSTUÃÃÅ°VWXYZ";
            const SOLVE_BONUSES = [5000, 7000, 10000, 10000, 12000, 12000, 15000, 15000, 15000, 25000];
            const HUGE_WIN_THRESHOLD = 4000;
            const MILLIONAIRE_THRESHOLD = 1000000;
            const MAIN_PRIZE_THRESHOLD = 150000;
            const MAIN_PRIZE_TIME = 30;
            const MINIGAME_PLAYS_PER_HOUR = 10;
            const LOTTO_COST = 5000;
            const MAX_LOTTO_TICKETS_PER_DAY = 5;
            const LOTTO_NUM_RANGE = 45;
            const LOTTO_PRIZES = {
                1: { id: 'one_hit_wonder', name: '1 TalÃ¡lat BÃ³nusz', duration: '24h', description: '24 Ã³rÃ¡s CSÅD vÃ©delem + 1 ingyen magÃ¡nhangzÃ³ minden feladvÃ¡nyban.' },
                2: { id: 'two_hit_reveal', name: 'KÃ¶nnyÃ­tett KezdÃ©s', duration: 'weekly', description: 'A hÃ©t vÃ©gÃ©ig 2 ajÃ¡ndÃ©k betÅ± a 8 karakternÃ©l hosszabb feladvÃ¡nyoknÃ¡l.' },
                3: { id: 'three_hit_boost', name: 'DuplÃ¡zÃ³ BÃ³nusz', duration: '24h', description: '24 Ã³rÃ¡s dupla mÃ¡ssalhangzÃ³-pÃ©nz + 2 ingyen magÃ¡nhangzÃ³ minden feladvÃ¡nyban.' },
                4: { id: 'four_hit_no_bankrupt', name: 'Teljes VÃ©delem', duration: 'weekly', description: 'A hÃ©t vÃ©gÃ©ig nincs CSÅD mezÅ a kerÃ©ken.' },
                5: { id: 'lotto_bajnok', name: 'LottÃ³Bajnok Jackpot', duration: 'weekly', description: 'A hÃ©t vÃ©gÃ©ig tartÃ³ Jackpot: 100.000 Ft azonnali jutalom, minden feladvÃ¡ny Arany FordulÃ³, Ã©s minden segÃ­tsÃ©g ingyenes!' }
            };

            
            const HOST_MESSAGES = {
                power_up: ["Mutasd a flow-t! MinÃ©l erÅsebb a pÃ¶rgetÃ©s, annÃ¡l nagyobb a nyeremÃ©ny!", "Adj bele mindent! PÃ¶rgess Ãºgy, mintha nem lenne holnap!", "Na lÃ¡ssuk, mekkora vibe van a csuklÃ³dban! KÃ¼ldd meg!", "Ideje megmutatni, ki a fÅnÃ¶k! Adj neki kakaÃ³t!", "Engedd szabadjÃ¡ra az energiÃ¡t! PÃ¶rgessÃ¼nk nagyot!"],
                start_game: ["HellÃ³, hellÃ³! Ãdv a stÃºdiÃ³ban, ahol a betÅ±k pÃ©nzt Ã©rnek! KezdÅdjÃ¶n a mÃ³ka!", "Szevasztok, arcok! KÃ©szen Ã¡lltok a pÃ¶rgetÃ©sre? LÃ¡ssuk, mit rejt az elsÅ feladvÃ¡ny!", "CsÅvÃ¡z, nagy jÃ¡tÃ©kos! Induljon a zsetonvadÃ¡szat! Az elsÅ feladvÃ¡ny mÃ¡r vÃ¡r!", "BekerÃ¼ltÃ©l a kÃ¶rforgÃ¡sba! Itt az idÅ, hogy megpÃ¶rgesd a szerencsÃ©det. LÃ¡ssuk a tÃ¡blÃ¡t!", "Sziasztok, PÃ¶rgetÅk! A stÃºdiÃ³ fÃ©nyei rÃ¡tok szegezÅdnek. KezdjÃ¼k is!"],
                start_round: ["Ãj kÃ¶r, Ãºj esÃ©lyek! A feladvÃ¡ny friss Ã©s ropogÃ³s, mint egy meleg pÃ©kÃ¡ru.", "Ãs mÃ¡r jÃ¶n is a kÃ¶vetkezÅ menet! A nehÃ©zsÃ©gi szint emelkedik, de a nyeremÃ©ny is!", "FelkÃ©szÃ¼lni, vigyÃ¡zz... Ãºj feladvÃ¡ny! LÃ¡ssuk, ez kifog-e rajtad!", "A tÃ¡bla tiszta, a zsetonok vÃ¡rnak. JÃ¶het a kÃ¶vetkezÅ kÃ¶r!", "Nem Ã¡llunk meg! Itt a friss feladvÃ¡ny, telis-tele rejtett forintokkal!"],
                spinning: ["A kerÃ©k forog, a szerencse kÃ¶zleg! Hol Ã¡ll meg vajon?", "PÃ¶rÃ¶g-forog, mint egy macska a lÃ©zerpÃ¶tty utÃ¡n! LÃ¡ssuk, mit fogsz!", "A kerÃ©k most 'loading...'. RemÃ©ljÃ¼k, valami nagyot tÃ¶lt be!", "Izgalom a kÃ¶bÃ¶n! A kerÃ©k pÃ¶rÃ¶g, a pulzus emelkedik!", "A kerÃ©knek lelke van, Ã©s most Ã©pp a te sorsodrÃ³l dÃ¶nt! HajrÃ¡!"],
                spin_result: ["<strong>{value} Ft</strong> a tÃ©t! EnnyibÅl mÃ¡r kijÃ¶n egy jÃ³fajta pizza. Melyik betÅ±t kÃ©red?", "Ez egy <strong>{value} Ft</strong>-os kÃ©rdÃ©s! Na, melyik mÃ¡ssalhangzÃ³ lapul a tÃ¡blÃ¡n?", "Remek pÃ¶rgetÃ©s: <strong>{value} Ft</strong>! Ez mÃ¡r egy szÃ©p kis zsebpÃ©nz. JÃ¶het a betÅ±!", "A kerÃ©k <strong>{value} Ft</strong>-ot dobott! Most te jÃ¶ssz, mutasd, mit tudsz!", "SzÃ©p fogÃ¡s! <strong>{value} Ft</strong> egyetlen betÅ±Ã©rt? JÃ³l hangzik! Melyik lesz az?"],
                correct_consonant: ["Ott van, nem is egy! Ez a betÅ± annyira telitalÃ¡lat, hogy flexelhetnÃ©l vele!", "BejÃ¶tt! TÃ¶bbszÃ¶r is! Ãgy potyognak a zsetonok, mint esÅben a cseppek!", "Ez az! A tÃ¡bla imÃ¡dja ezt a betÅ±t! Ãs a pÃ©nztÃ¡rcÃ¡d is imÃ¡dni fogja.", "Bingo! Ez a betÅ± Ãºgy kellett ide, mint sivatagba egy pohÃ¡r vÃ­z. GratulÃ¡lok!", "TÃ¶kÃ©letes! Ez a betÅ± annyira a helyÃ©n van, mint a hab a tortÃ¡n. Zsebeld be a lÃ³vÃ©t!"],
                bankrupt: ["Jaj, ne! <strong>CSÅD!</strong> A kÃ¶rÃ¶s zsetonok elszÃ¡lltak, mint a gyenge wifi-jel.", "Bumm! A fekete lyuk elnyelte a kÃ¶rÃ¶s nyeremÃ©nyed. Sebaj, a kÃ¶vetkezÅ kÃ¶rben visszavÃ¡ghatsz!", "A pÃ©nz elpÃ¡rolgott... de a tudÃ¡s a tiÃ©d marad! Fel a fejjel!", "CSÅD! Ez most fÃ¡jt, mint legÃ³ba lÃ©pni. De a jÃ¡tÃ©k megy tovÃ¡bb!", "A kÃ¶rÃ¶s pÃ©nznek annyi. De ne add fel, a nagy fogÃ¡s mÃ©g hÃ¡travan!"],
                solve_success: ["<strong>MEGFEJTÃS!</strong> KirÃ¡ly vagy! AgysebÃ©sz lehetsz, vagy csak simÃ¡n zseni? Ãsszesen <strong>{totalGained} Ft</strong> a jutalmad!", "Megvan! Olyan simÃ¡n lehoztad, mint egy profi! NyeremÃ©nyed: <strong>{totalGained} Ft</strong>! Pacsi!", "KÃ©sz! Ezzel a megfejtÃ©ssel beÃ­rtad magad a nagykÃ¶nyvbe! <strong>{totalGained} Ft</strong> a jutalom!", "Siker! A stÃºdiÃ³ felrobbant! <strong>{totalGained} Ft</strong> Ã¼ti a markod! Ez az, gratulÃ¡lok!", "Megfejtve! EzÃ©rt a teljesÃ­tmÃ©nyÃ©rt Ã³riÃ¡si pacsi jÃ¡r! A pÃ©nz mÃ¡r a tiÃ©d!"],
                solve_fail: ["HoppÃ¡, ez mellÃ©ment! Ez a tipp annyira volt jÃ³, mint a papucs a hÃ³ban.", "Sajnos nem. De a prÃ³bÃ¡lkozÃ¡s is szÃ¡mÃ­t! Csak most Ã©pp zsetonba kerÃ¼l...", "Nem talÃ¡lt! Ez most nem jÃ¶tt Ã¶ssze. Sebaj, 'hakuna matata'!", "Ez a megfejtÃ©s sajnos nem az igazi. A bÃ¼ntetÃ©s levonva, de a jÃ¡tÃ©k folytatÃ³dik!"],
                double_or_nothing_prompt: ["<strong>DUPLA VAGY SEMMI!</strong> BevÃ¡llalÃ³s vagy? A tÃ©t a kÃ¶rÃ¶s pÃ©nzed: <strong>{points} Ft</strong>. Mondj egy mÃ¡ssalhangzÃ³t!", "Itt a 'mindent vagy semmit' pillanat! KockÃ¡ztatsz <strong>{points} Ft</strong>-ot? JÃ¶het a betÅ±!"],
                double_win: ["<strong>DUPLA!</strong> BejÃ¶tt a rizikÃ³! A bÃ¡trakÃ© a szerencse, Ã©s most a zseton is!", "SikerÃ¼lt! MegduplÃ¡ztad a pÃ©nzed! Ez az, amiÃ©rt megÃ©ri jÃ¡tszani!"],
                double_lose: ["<strong>SEMMI!</strong> A szerencse most elment kÃ¡vÃ©zni. A kÃ¶rÃ¶s pÃ©nz bÃ¡nta.", "Aki mer, az nÃ©ha veszÃ­t. Ez most egy ilyen pillanat volt. Fel a fejjel!"],
                main_prize_qualified: ["<strong>GratulÃ¡lok!</strong> KvalifikÃ¡ltad magad a FÅdÃ­j JÃ¡tÃ©kra! MÃ¡r csak egy lÃ©pÃ©sre vagy a hatalmas nyeremÃ©nytÅl!", "Fantasztikus! Jogosult vagy a FÅdÃ­j JÃ¡tÃ©kra! Itt az esÃ©ly, hogy igazÃ¡n nagyot szakÃ­ts!"],
                assistance_spin: ["A rendszer sÃºg egy kicsit... A(z) <strong>{letter}</strong> betÅ±vel most nagyot nyerhetsz!", "A <strong>SEGÃTSÃG</strong> megÃ©rkezett! PrÃ³bÃ¡lkozz a(z) <strong>{letter}</strong> betÅ±vel! BÃ­zz a gÃ©pben!"],
                halver_spin: ["Jaj, ne! Ez a <strong>FELEZÅ!</strong> A kÃ¶rÃ¶s pÃ©nzed fele elment diÃ©tÃ¡zni.", "A felezÅ lecsapott! BosszantÃ³, de mÃ©g Ã­gy is maradt mit hazavinni a kÃ¶rbÅl."],
                bankrupt_sunday: ["Ã, a vÃ©gzet vasÃ¡rnap! <strong>CSÅD!</strong> Nemcsak a kÃ¶rÃ¶s nyeremÃ©ny, de a feltett <strong>{bet}&nbsp;Ft-os tÃ©t is elÃºszott!</strong> KemÃ©ny menet."],
                lose_turn: ["<strong>KIMARADSZ!</strong> Most pihensz egy kÃ¶rt. HasznÃ¡ld ki egy kis stratÃ©giai tervezÃ©sre!", "HoppÃ¡, egy kis pihenÅ! MindjÃ¡rt Ãºjra te jÃ¶ssz."],
                bonus_points: ["<strong>+{value}&nbsp;FT!</strong> Csak Ãºgy, ajÃ¡ndÃ©kba! Ezt zsebeld is be gyorsan!", "Azonnali <strong>{value} Ft</strong>! GratulÃ¡lok, ez szÃ©pen jÃ¶tt!"],
                huge_win_consonant: ["Ez igen! Egyetlen betÅ±vel <strong>{earnings}&nbsp;Ft</strong>! Ez a pÃ¶rgetÃ©s... 'chef's kiss'!", "Hatalmas fogÃ¡s! <strong>{earnings}</strong> forint egy betÅ±vel! Ez mÃ¡r dÃ¶fi!"],
                correct_vowel: ["Igen, van benne <strong>{count}</strong> darab! A tÃ¡bla a barÃ¡tod.", "JÃ³l sejted, a tÃ¡blÃ¡n ott virÃ­t <strong>{count}</strong> ilyen betÅ±!"],
                wrong_letter: ["SajnÃ¡lom, de ez a betÅ± most szabadsÃ¡gon van.", "Ez a betÅ± ma nem dolgozik a stÃºdiÃ³ban. PrÃ³bÃ¡lj egy mÃ¡sikat!", "A betÅ±fal nemet intett. Sebaj, a kÃ¶vetkezÅ tuti bejÃ¶n!"],
                solve_golden_success: ["<strong>ARANY MEGFEJTÃS!</strong> Dupla pÃ©nz, dupla Ã¶rÃ¶m! A kÃ¶rÃ¶s nyeremÃ©ny Ã©s a bÃ³nusz is duplÃ¡zÃ³dik! Hatalmas gratulÃ¡ciÃ³, <strong>{totalGained}&nbsp;Ft</strong> a tiÃ©d!", "Ez az! Megfejtetted az Arany FeladvÃ¡nyt! A jutalom nem marad el, a kasszÃ¡d most kÃ©tszer hangosabban csÃ¶rÃ¶g: <strong>{totalGained}&nbsp;Ft</strong>!"],
                solve_sunday_success: ["<strong>SIKERES KÃR!</strong> A <strong>{bet}&nbsp;Ft-os tÃ©t visszajÃ¡r</strong>, a kÃ¶rÃ¶s nyeremÃ©ny Ã©s a bÃ³nusz pedig hozzÃ¡adÃ³dik a Heti KasszÃ¡hoz! Ãsszesen <strong>{totalGained}&nbsp;Ft</strong> a gyarapodÃ¡s!"],
                game_over: ["Az erre az Ã³rÃ¡ra szÃ¡nt jÃ¡tÃ©k vÃ©get Ã©rt. Pihenj egyet, Ã©s gyere vissza kÃ©sÅbb! VÃ©gsÅ egyenleged: <strong>{score}&nbsp;Ft</strong>.", "VÃ©ge a dalnak mÃ¡ra! A vÃ©geredmÃ©ny: <strong>{score}</strong> forint. SzÃ©p munka volt, pacsi!"],
                main_prize_win: ["ELKÃPESZTÅ! MEGVAN! A FÅdÃ­j a tiÃ©d! A nyeremÃ©nyed megduplÃ¡zva: <strong>{winnings}&nbsp;Ft!</strong> Te vagy a bajnok!", "A stÃºdiÃ³ felrobbant! MegcsinÃ¡ltad! <strong>{winnings}&nbsp;Ft</strong> a jutalom! ÃriÃ¡si vagy!"],
                main_prize_lose: ["Jaj, ne! Sajnos nem ez volt a helyes megfejtÃ©s. A FÅdÃ­j elÃºszott. De szÃ©p menet volt idÃ¡ig!", "Ã, milyen kÃ¡r! Ez most nem jÃ¶tt Ã¶ssze. De ne csÃ¼ggedj, a kÃ¶vetkezÅ Ã³rÃ¡ban Ãºjra bizonyÃ­thatsz!"],
                main_prize_lose_timeout: ["LejÃ¡rt az idÅ! Ã, milyen kÃ¡r! Az idÅ a legnagyobb ellenfÃ©l. A FÅdÃ­j sajnos nem lett meg.", "Az Ã³ra legyÅzÃ¶tt! A FÅdÃ­j elÃºszott, de a tapasztalat a tiÃ©d marad!"],
                turn_end: ["Ãjra te jÃ¶ssz! Mutasd, mi a kÃ¶vetkezÅ lÃ©pÃ©s!", "IsmÃ©t tiÃ©d a terep! PÃ¶rgess, vagy vegyÃ©l egy magÃ¡nhangzÃ³t!", "FolytatÃ³dhat a menet! TiÃ©d a pÃ¡lya!"],
                no_more_consonants: ["Az Ã¶sszes mÃ¡ssalhangzÃ³ elfogyott! VegyÃ©l magÃ¡nhangzÃ³t, vagy fejtsd meg! A cÃ©legyenesben vagy!", "Nincs tÃ¶bb mÃ¡ssalhangzÃ³ a kalapban! MÃ¡r csak a magÃ¡nhangzÃ³k segÃ­thetnek, vagy a zseniÃ¡lis elmÃ©d!"],
                start_golden_round: ["VigyÃ¡zat! <strong>â­ ARANY FORDULÃ!</strong> Most minden nyeremÃ©ny duplÃ¡n szÃ¡mÃ­t! Itt az idÅ nagyot Ã¡lmodni!", "Ez az! Egy <strong>â­ ARANY FORDULÃ!</strong> Itt igazÃ¡n megÃ©ri kockÃ¡ztatni!"],
                sunday_greeting: ["Ãdv a PrÃ©mium VasÃ¡rnapban! Itt a heti kasszÃ¡d a tÃ©t. LÃ¡ssuk, mennyit mersz kockÃ¡ztatni!", "VasÃ¡rnap van, a nagy fogadÃ¡sok napja! Tedd meg a tÃ©tet, Ã©s induljon a jÃ¡tÃ©k a fÅdÃ­jÃ©rt!"],
                quit_warning: ["VigyÃ¡zat! Ebben az Ã³rÃ¡ban mÃ¡r kilÃ©ptÃ©l egyszer. Ha most ismÃ©t kilÃ©psz, az eddigi nyeremÃ©nyed elvÃ©sz!", "MÃ¡sodik esÃ©ly ebben az Ã³rÃ¡ban! Ha most abbahagyod, a jelenlegi gyÅ±jtÃ©sed nullÃ¡zÃ³dik."],
                free_vowel_spin: ["<strong>INGYEN MÃNHANGZÃ!</strong> Szuper! A kÃ¶vetkezÅ magÃ¡nhangzÃ³ a hÃ¡z ajÃ¡ndÃ©ka!", "Ezt nevezem! Most ingyen vehetsz egy magÃ¡nhangzÃ³t, csak Ãºgy, lazÃ¡n!"],
                surprise_spin_money: ["<strong>MEGLEPETÃS!</strong> A kerÃ©k egy kis bÃ³nusszal ajÃ¡ndÃ©koz meg: <strong>{value} Ft!</strong> Csak Ãºgy, mert jÃ³ fej.", "HoppÃ¡, egy kis meglepetÃ©s! NyeremÃ©nyed <strong>{value} Ft!</strong> Ezt zsebeld be!"],
                surprise_spin_vowel: ["<strong>MEGLEPETÃS!</strong> A jutalmad egy ingyen magÃ¡nhangzÃ³! Micsoda szerencse!", "A kerÃ©k ma bÅkezÅ±: tessÃ©k, egy ingyen magÃ¡nhangzÃ³!"],
            };
            
            // SCRIPT
            let gameState;
            let hourlyPuzzleIndices;
            let currentModal = { resolve: null, reject: null };
            let isSunday = new Date().getDay() === 0;
            let mainPrizeTimerInterval;
            let nyero21State = {};
            let lottoState = { selectedNumbers: [] };
            let powerAnimationId = null;
            let isDevModeActive = false;

            const SURPRISE_EVENTS = [
                { id: 'villam_bonusz', text: "MEGLEPETÃS! VillÃ¡m BÃ³nusz! Azonnal kapsz <strong>5,000 Ft</strong>-ot!", execute: (gs) => { gs.roundWinnings += 5000; endTurn(); } },
                { id: 'zseton_eso', text: "MEGLEPETÃS! Zseton EsÅ! Minden, a tÃ¡blÃ¡n mÃ¡r felfedett mÃ¡ssalhangzÃ³ utÃ¡n kapsz <strong>500 Ft</strong>-ot!", execute: (gs) => {
                    const currentPuzzle = allPuzzles[hourlyPuzzleIndices[gs.currentRound - 1]].puzzle.toUpperCase();
                    const revealedConsonants = gs.guessedLetters.filter(l => !VOWELS.includes(l) && currentPuzzle.includes(l));
                    const bonus = revealedConsonants.length * 500;
                    if (bonus > 0) {
                        gs.roundWinnings += bonus;
                        updateHostMessage(`Zseton EsÅ! A ${revealedConsonants.length} felfedett mÃ¡ssalhangzÃ³Ã©rt ${bonus.toLocaleString('hu-HU')} Ft a jutalmad!`, true);
                    }
                    endTurn();
                }},
                { id: 'huseg_bonusz', text: "MEGLEPETÃS! HÅ±sÃ©g BÃ³nusz! Az eddigi kÃ¶rÃ¶s nyeremÃ©nyed <strong>10%-Ã¡t</strong> megkapod extrakÃ©nt!", execute: (gs) => {
                    const bonus = Math.floor(gs.roundWinnings * 0.1);
                    if (bonus > 0) gs.roundWinnings += bonus;
                    endTurn();
                }},
                { id: 'kategoria_bonusz', text: "MEGLEPETÃS! KategÃ³ria BÃ³nusz! A kÃ¶vetkezÅ sikeres mÃ¡ssalhangzÃ³-tipped a pÃ¶rgetett Ã©rtÃ©k <strong>duplÃ¡jÃ¡t</strong> Ã©ri!", execute: (gs) => {
                    gs.isCategoryBonusActive = true;
                    endTurn();
                }},
                { id: 'ingyen_maganhangzo', text: "MEGLEPETÃS! A kerÃ©k ma bÅkezÅ±: tessÃ©k, egy ingyen magÃ¡nhangzÃ³!", execute: (gs) => {
                    gs.hasFreeVowel = true;
                    endTurn();
                }},
                { id: 'csod_vedelem', text: "MEGLEPETÃS! CSÅD VÃ©delem! A kÃ¶vetkezÅ pÃ¶rgetÃ©sed sorÃ¡n, ha a CSÅD mezÅre Ã©rsz, a nyeremÃ©nyed <strong>biztonsÃ¡gban marad!</strong>", execute: (gs) => {
                    gs.hasBankruptProtection = true;
                    endTurn();
                }},
                { id: 'felezo_visszavonas', text: "MEGLEPETÃS! FelezÅ VisszavonÃ¡s! Ha pÃ¶rgettÃ©l mÃ¡r felezÅt ebben a kÃ¶rben, most visszakapod az elvesztett Ã¶sszeget!", execute: (gs) => {
                    if (gs.halverAmountLostThisRound > 0) {
                        gs.roundWinnings += gs.halverAmountLostThisRound;
                        gs.halverAmountLostThisRound = 0;
                    }
                    endTurn();
                }},
                { id: 'ingyen_megfejtes', text: "MEGLEPETÃS! Ingyen MegfejtÃ©si KÃ­sÃ©rlet! Most bÃ¼ntetÃ©s nÃ©lkÃ¼l tippelhetsz a megoldÃ¡sra!", execute: (gs) => {
                    gs.hasFreeSolveAttempt = true;
                    endTurn();
                }},
                { id: 'dupla_bonusz', text: "MEGLEPETÃS! Dupla BÃ³nusz! Ha ebben a kÃ¶rben megfejted a feladvÃ¡nyt, a megfejtÃ©si bÃ³nusz megduplÃ¡zÃ³dik!", execute: (gs) => {
                    gs.isSolveBonusDoubled = true;
                    endTurn();
                }},
                { id: 'lotto_bonusz', text: "MEGLEPETÃS! LottÃ³ BÃ³nusz! KaptÃ¡l egy ingyenes Napi LottÃ³ szelvÃ©nyt! A kÃ¶vetkezÅ lottÃ³vÃ¡sÃ¡rlÃ¡sod ingyenes lesz.", execute: (gs) => {
                    gs.hasFreeLottoTicket = true;
                    endTurn();
                }},
                { id: 'rejtelyes_betu', text: "MEGLEPETÃS! RejtÃ©lyes BetÅ±! A gÃ©p vÃ¡laszt egy mÃ¡ssalhangzÃ³t. Ha szerepel a tÃ¡blÃ¡n, minden darabÃ©rt 1,000 Ft-ot kapsz.", execute: (gs) => {
                    const puzzleStr = allPuzzles[hourlyPuzzleIndices[gs.currentRound - 1]].puzzle.toUpperCase();
                    const unGuessedConsonants = FULL_ALPHABET.split('').filter(char => !VOWELS.includes(char) && !gs.guessedLetters.includes(char));
                    if(unGuessedConsonants.length > 0){
                        const randomLetter = unGuessedConsonants[Math.floor(Math.random() * unGuessedConsonants.length)];
                        const foundCount = (puzzleStr.match(new RegExp(randomLetter, "g")) || []).length;
                        if (foundCount > 0) {
                             const bonus = foundCount * 1000;
                             gs.roundWinnings += bonus;
                             updateHostMessage(`A rejtÃ©lyes betÅ± a(z) <strong>${randomLetter}</strong> volt! ${foundCount} db van belÅle, nyertÃ©l ${bonus.toLocaleString('hu-HU')} Ft-ot!`, true);
                             gs.guessedLetters.push(randomLetter);
                             revealAndCalculate(randomLetter, false, foundCount, true);
                        } else {
                            updateHostMessage(`A rejtÃ©lyes betÅ± a(z) <strong>${randomLetter}</strong> volt, de sajnos nincs a feladvÃ¡nyban.`, true);
                            endTurn();
                        }
                    } else { endTurn(); }
                }},
                { id: 'rossz_tanacs', text: "MEGLEPETÃS! A mÅ±sorvezetÅ sÃºg: 'Szerintem a(z) <strong>{letter}</strong> betÅ±vel prÃ³bÃ¡lkozz!' De vajon megbÃ­zhatsz benne?", execute: (gs) => {
                    const puzzleStr = allPuzzles[hourlyPuzzleIndices[gs.currentRound - 1]].puzzle.toUpperCase();
                    const notInPuzzle = FULL_ALPHABET.split('').filter(char => !VOWELS.includes(char) && !puzzleStr.includes(char));
                    const letter = notInPuzzle.length > 0 ? notInPuzzle[Math.floor(Math.random() * notInPuzzle.length)] : 'X';
                    updateHostMessage(`MEGLEPETÃS! A mÅ±sorvezetÅ sÃºg: "Szerintem a(z) <strong>${letter}</strong> betÅ±vel prÃ³bÃ¡lkozz!" De vajon megbÃ­zhatsz benne?`, true);
                    endTurn();
                }},
                { id: 'kockadobas', text: "MEGLEPETÃS! KockadobÃ¡s! A dobott Ã©rtÃ©k 1,000-szerese a jutalmad!", execute: (gs) => {
                    const roll = Math.floor(Math.random() * 6) + 1;
                    const prize = roll * 1000;
                    gs.roundWinnings += prize;
                    updateHostMessage(`A kocka <strong>${roll}</strong>-t mutatott! NyeremÃ©nyed: <strong>${prize.toLocaleString('hu-HU')} Ft!</strong>`, true);
                    endTurn();
                }},
                { id: 'azonnali_segitseg', text: "MEGLEPETÃS! Azonnali SegÃ­tsÃ©g! A gÃ©p felfedi a kÃ¶vetkezÅ rejtett betÅ±t.", execute: (gs) => {
                     const puzzleStr = allPuzzles[hourlyPuzzleIndices[gs.currentRound - 1]].puzzle.toUpperCase();
                     for(const char of puzzleStr) {
                         if (FULL_ALPHABET.includes(char) && !gs.guessedLetters.includes(char)) {
                             gs.guessedLetters.push(char);
                             const foundCount = (puzzleStr.match(new RegExp(char, "g")) || []).length;
                             revealAndCalculate(char, VOWELS.includes(char), foundCount, true);
                             return;
                         }
                     }
                     endTurn();
                }},
                 { id: 'technikai_baki', text: "MEGLEPETÃS! Technikai baki! A kerÃ©k megakadt, a pÃ¶rgetÃ©s Ã©rvÃ©nytelen. PÃ¶rgess Ãºjra!", execute: (gs) => {
                    setTimeout(togglePowerMeter, 1500);
                }},
                { id: 'mini_csod', text: "MEGLEPETÃS! Mini CSÅD! Sajnos elveszÃ­ted a kÃ¶rÃ¶s nyeremÃ©nyed <strong>10%</strong>-Ã¡t.", execute: (gs) => {
                    const loss = Math.floor(gs.roundWinnings * 0.1);
                    gs.roundWinnings -= loss;
                    endTurn();
                }},
                { id: 'zarlat_studioban', text: "MEGLEPETÃS! ZÃ¡rlat a stÃºdiÃ³ban! Ki kell hagynod egy kÃ¶rt.", execute: (gs) => {
                    endTurn();
                }},
                { id: 'adoellenor', text: "MEGLEPETÃS! AdÃ³ellenÅr! VÃ¡ratlanul levonnak tÅled <strong>1,500 Ft</strong>-ot a kÃ¶rÃ¶s nyeremÃ©nyedbÅl.", execute: (gs) => {
                    gs.roundWinnings = Math.max(0, gs.roundWinnings - 1500);
                    endTurn();
                }},
                { id: 'tipp_vasarlas', text: "MEGLEPETÃS! KÃ¶telezÅ vÃ¡sÃ¡rlÃ¡s! A gÃ©p vesz neked egy magÃ¡nhangzÃ³t a pÃ©nzedbÅl.", execute: (gs) => {
                    const cost = getCurrentVowelCost();
                    if (gs.roundWinnings >= cost && gs.vowelsPurchasedThisRound < 10) {
                         gs.roundWinnings -= cost;
                         gs.vowelsPurchasedThisRound++;
                         updateHostMessage(`MEGLEPETÃS! A gÃ©p megvette neked a kÃ¶vetkezÅ magÃ¡nhangzÃ³t ${cost} Ft-Ã©rt. Most tippelhetsz egyet ingyen!`, true)
                    } else {
                         updateHostMessage("MEGLEPETÃS! A gÃ©p venni akart egy magÃ¡nhangzÃ³t, de nincs elÃ©g pÃ©nzed rÃ¡. SzerencsÃ©d volt!", true);
                         endTurn();
                    }
                }},
                { id: 'varatlan_kiadas', text: "MEGLEPETÃS! VÃ¡ratlan kiadÃ¡s! A stÃºdiÃ³ karbantartÃ¡sÃ¡ra levonnak tÅled <strong>1,000 Ft</strong>-ot.", execute: (gs) => {
                    gs.roundWinnings = Math.max(0, gs.roundWinnings - 1000);
                    endTurn();
                }},
            ];
            
            // DOM Elements
            const wheel = document.getElementById('wheel');
            const wheelCenterButton = document.getElementById('wheel-center-button');
            const wheelCenterText = document.getElementById('wheel-center-text');
            const boosterBar = document.querySelector('.booster-bar');
            const solveButton = document.getElementById('solve-button');
            const newGameButton = document.getElementById('new-game-button');
            const skipErrorBtn = document.getElementById('skip-error-btn');
            const nyero21Button = document.getElementById('nyero21-button');
            const lottoButton = document.getElementById('lotto-button');
            const transferButton = document.getElementById('transfer-button');
            const solveButtonDesktop = document.getElementById('solve-button-desktop');
            const nyero21ButtonDesktop = document.getElementById('nyero21-button-desktop');
            const lottoButtonDesktop = document.getElementById('lotto-button-desktop');
            const transferButtonDesktop = document.getElementById('transfer-button-desktop');
            const puzzleBoard = document.getElementById('puzzle-board');
            const puzzleCategory = document.getElementById('puzzle-category');
            const lottoBajnokIcon = document.getElementById('lotto-bajnok-icon');
            const freeVowelIndicator = document.getElementById('free-vowel-indicator');
            const roundInfoContainer = document.getElementById('round-info-container');
            const scoreDisplay = document.getElementById('score-display');
            const hourlyWinningsDisplay = document.getElementById('hourly-winnings-display');
            const roundWinningsDisplay = document.getElementById('round-winnings-display');
            const roundDisplay = document.getElementById('round-display');
            const hourBlockDisplay = document.getElementById('hour-block-display');
            const hostMessageMobile = document.getElementById('host-message');
            const hostMessageDesktop = document.getElementById('host-message-desktop');
            const alphabetPanel = document.getElementById('alphabet-panel');
            const mainHudLabel = document.getElementById('main-hud-label');
            const wonPrizeContainer = document.getElementById('won-prize-container');
            const wonPrizeName = document.getElementById('won-prize-name');
            const autoHintsContainer = document.getElementById('auto-hints-container');
            const modalOverlay = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('custom-modal-title');
            const modalText = document.getElementById('custom-modal-text');
            const modalButtons = document.getElementById('custom-modal-buttons');
            const solveInput = document.getElementById('solve-input');
            const devModal = document.getElementById('dev-modal');
            const devForceMainPrizeBtn = document.getElementById('dev-force-main-prize');
            const devTestLottoBtn = document.getElementById('dev-test-lotto');
            const devTestNyero21Btn = document.getElementById('dev-test-nyero21');
            const devModalCloseBtn = document.getElementById('dev-modal-close-btn');
            const logoContainer = document.getElementById('logo-container');
            const mainPrizeModal = document.getElementById('main-prize-modal');
            const mainPrizeTitle = document.getElementById('main-prize-title');
            const mainPrizeCategory = document.getElementById('main-prize-category');
            const mainPrizeBoard = document.getElementById('main-prize-board');
            const mainPrizeGivenLetters = document.getElementById('main-prize-given-letters');
            const mainPrizeFinalAnswer = document.getElementById('main-prize-final-answer');
            const mainPrizeTimer = document.getElementById('main-prize-timer');
            const mainPrizeInstructions = document.getElementById('main-prize-instructions');
            const mainPrizeSolveInput = document.getElementById('main-prize-solve-input');
            const mainPrizeSelectConfirmBtn = document.getElementById('main-prize-select-confirm-btn');
            const mainPrizeConfirmBtn = document.getElementById('main-prize-confirm-btn');
            const mainPrizeCloseBtn = document.getElementById('main-prize-close-btn');
            const mainPrizeProgress = document.getElementById('main-prize-progress');
            const mainPrizeAlphabetContainer = document.getElementById('main-prize-alphabet-panel-container');
            const nyero21Modal = document.getElementById('nyero21-modal');
            const nyero21StakingArea = document.getElementById('nyero21-staking-area');
            const nyero21GameArea = document.getElementById('nyero21-game-area');
            const nyero21PlayerBalance = document.getElementById('nyero21-player-balance');
            const nyero21StakeInput = document.getElementById('nyero21-stake-input');
            const nyero21PlaysLeft = document.getElementById('nyero21-plays-left');
            const nyero21StartGameBtn = document.getElementById('nyero21-start-game-btn');
            const nyero21CancelBtn = document.getElementById('nyero21-cancel-btn');
            const nyero21InfoBar = document.getElementById('nyero21-info-bar');
            const nyero21CardDeck = document.getElementById('nyero21-card-deck');
            const nyero21PlayerScore = document.getElementById('nyero21-player-score');
            const nyero21ResultMessage = document.getElementById('nyero21-result-message');
            const nyero21HitBtn = document.getElementById('nyero21-hit-btn');
            const nyero21StandBtn = document.getElementById('nyero21-stand-btn');
            const nyero21NewGameBtn = document.getElementById('nyero21-new-game-btn');
            const nyero21CloseBtn = document.getElementById('nyero21-close-btn');
            const lottoModal = document.getElementById('lotto-modal');
            const lottoTitle = document.getElementById('lotto-title');
            const lottoInfoArea = document.getElementById('lotto-info-area');
            const lottoStatusText = document.getElementById('lotto-status-text');
            const lottoCostText = document.getElementById('lotto-cost-text');
            const lottoDrawingContainer = document.getElementById('lotto-drawing-container');
            const lottoDrawingDate = document.getElementById('lotto-drawing-date');
            const lottoWinningNumbers = document.getElementById('lotto-winning-numbers');
            const lottoSubmittedTickets = document.getElementById('lotto-submitted-tickets');
            const lottoBettingArea = document.getElementById('lotto-betting-area');
            const lottoGrid = document.getElementById('lotto-grid');
            const lottoSelectedDisplay = document.getElementById('lotto-selected-display');
            const lottoSubmitBtn = document.getElementById('lotto-submit-btn');
            const lottoBuyTicketBtn = document.getElementById('lotto-buy-ticket-btn');
            const lottoCancelBtn = document.getElementById('lotto-cancel-btn');
            const lottoCancelBetBtn = document.getElementById('lotto-cancel-bet-btn');
            const lottoPrizeHud = document.getElementById('lotto-prize-hud');
            const lottoPrizeCount = document.getElementById('lotto-prize-count');
            const activeBonusesModal = document.getElementById('active-bonuses-modal');
            const activeBonusesList = document.getElementById('active-bonuses-list');
            const activeBonusesCloseBtn = document.getElementById('active-bonuses-close-btn');
            const prizeChestHud = document.getElementById('prize-chest-hud');
            const prizeChestCount = document.getElementById('prize-chest-count');
            const prizeChestModal = document.getElementById('prize-chest-modal');
            const prizeChestList = document.getElementById('prize-chest-list');
            const prizeChestCloseBtn = document.getElementById('prize-chest-close-btn');

            const boosterRadius = 45;
            const circumference = 2 * Math.PI * boosterRadius;
            boosterBar.style.strokeDasharray = circumference;
            boosterBar.style.strokeDashoffset = circumference;
            
            function updateHostMessage(message, isImportant = false) {
                hostMessageMobile.innerHTML = message;
                hostMessageDesktop.innerHTML = message;
                const borderColor = isImportant ? 'var(--accent-gold)' : 'var(--tile-border-color)';
                hostMessageMobile.style.borderColor = borderColor;
                hostMessageDesktop.style.borderColor = borderColor;
            }
            
            function getFormattedDate(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
                return d.getUTCFullYear() + '-W' + weekNo.toString().padStart(2, '0');
            }

            function loadWeeklyScore() {
                const currentWeek = getWeekNumber(new Date());
                const savedWeek = localStorage.getItem('pordgesdFelWeekId');
                if (currentWeek !== savedWeek) {
                    localStorage.setItem('pordgesdFelWeeklyScore', '0');
                    localStorage.setItem('pordgesdFelWeekId', currentWeek);
                    localStorage.removeItem('quitHourId'); 
                    localStorage.removeItem('nyero21HourId');
                    localStorage.removeItem('pordgesdFelActiveBonuses');
                    localStorage.removeItem('pordgesdFelPrizeInventory');
                }
                return parseInt(localStorage.getItem('pordgesdFelWeeklyScore') || '0', 10);
            }

            function saveWeeklyScore(score) {
                 localStorage.setItem('pordgesdFelWeeklyScore', score.toString());
            }

            function seededRandom(seed) {
                let state = seed;
                return function() {
                    state = (state * 9301 + 49297) % 233280;
                    return state / 233280;
                };
            }

            function getHourlyPuzzles(randomGenerator) {
                const regularPuzzles = allPuzzles.filter(p => p.category !== 'FÅdÃ­j FeladvÃ¡ny');
                const regularPuzzleIndices = regularPuzzles.map(p => allPuzzles.indexOf(p));
                
                for (let i = regularPuzzleIndices.length - 1; i > 0; i--) {
                    const j = Math.floor(randomGenerator() * (i + 1));
                    [regularPuzzleIndices[i], regularPuzzleIndices[j]] = [regularPuzzleIndices[j], regularPuzzleIndices[i]];
                }
                
                return regularPuzzleIndices.slice(0, Math.min(PUZZLES_PER_HOUR, regularPuzzles.length));
            }
            
            function getRandomMessage(category, replacements = {}) {
                const messages = HOST_MESSAGES[category];
                if (!messages || messages.length === 0) {
                    return `HIÃNYZÃ ÃZENET: ${category}`;
                };
                let message = messages[Math.floor(Math.random() * messages.length)];
                for (const key in replacements) {
                    message = message.replace(new RegExp(`{${key}}`, 'g'), replacements[key]);
                }
                return message;
            }

            function resetGameState(isNewGame = false) {
                const oldState = gameState;
                gameState = {
                    playerScore: isNewGame ? loadWeeklyScore() : (oldState ? oldState.playerScore : 0),
                    hourlyWinnings: 0, 
                    roundWinnings: 0,
                    currentRound: 1,
                    totalRounds: PUZZLES_PER_HOUR,
                    puzzleHourId: null,
                    nyero21PlaysThisHour: 0,
                    currentBet: 0,
                    currentSpinValue: null,
                    isSpinning: false,
                    isPoweringUp: false,
                    currentPower: 0,
                    awaitingConsonant: false,
                    isDoubleOrNothingTurn: false,
                    hasFreeVowel: false,
                    inMainPrizeSelection: false,
                    noMoreConsonants: false,
                    guessedLetters: [],
                    mainPrizeConsonants: [],
                    mainPrizeVowels: [],
                    mainPrizeStake: 0,
                    isDevMainPrizeTest: false,
                    specialPrizeWon: false,
                    wonPrizes: [],
                    mainPrizeQualifiedNotified: false,
                    isMillionaire: false,
                    gameInProgress: false,
                    transferUsedThisHour: false,
                    consecutiveWrongConsonants: 0,
                    vowelsPurchasedThisRound: 0,
                    isCategoryBonusActive: false,
                    hasBankruptProtection: false,
                    halverAmountLostThisRound: 0,
                    hasFreeSolveAttempt: false,
                    isSolveBonusDoubled: false,
                    hasFreeLottoTicket: false,
                };
            }

            function setupPuzzleBoard(boardElement, puzzleData) {
                boardElement.innerHTML = '';
                const words = puzzleData.puzzle.toUpperCase().split(' ');
                const rows = [];
                let currentRow = [];
                let currentLength = 0;
                const maxRowLength = window.innerWidth < 480 ? 10 : (window.innerWidth < 901 ? 12 : 16);
                
                words.forEach(word => {
                    if (currentLength + word.length > maxRowLength && currentRow.length > 0) {
                        rows.push(currentRow);
                        currentRow = [];
                        currentLength = 0;
                    }
                    currentRow.push(word);
                    currentLength += word.length + 1;
                });
                rows.push(currentRow);

                rows.forEach(wordArray => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'puzzle-row';
                    wordArray.forEach((word, wordIndex) => {
                        word.split('').forEach(char => {
                            const tile = document.createElement('div');
                            if (char === ' ') {
                                tile.className = 'puzzle-tile space';
                            } else if (FULL_ALPHABET.includes(char)) {
                                tile.className = 'puzzle-tile';
                                tile.innerHTML = `<div class="tile-inner"><div class="tile-face tile-front"></div><div class="tile-face tile-back">${char}</div></div>`;
                                tile.dataset.letter = char;
                            } else {
                                tile.className = 'puzzle-tile special-char';
                                tile.textContent = char;
                            }
                            rowDiv.appendChild(tile);
                        });
                        
                        if(wordIndex < wordArray.length - 1) {
                             const spaceTile = document.createElement('div');
                             spaceTile.className = 'puzzle-tile space';
                             rowDiv.appendChild(spaceTile);
                        }
                    });
                    boardElement.appendChild(rowDiv);
                });
            }

            function createAlphabetPanel(container = alphabetPanel) {
                container.innerHTML = '';
                FULL_ALPHABET.split('').forEach(letter => {
                    const key = document.createElement('button');
                    key.className = 'alphabet-key';
                    key.textContent = letter;
                    key.dataset.letter = letter;
                    if (VOWELS.includes(letter)) key.classList.add('vowel');
                    key.addEventListener('click', () => handleLetterGuess(letter));
                    container.appendChild(key);
                });
            }
            
            function getCurrentVowelCost() {
                if (isPrizeActive('lotto_bajnok')) return 0;
                let freeVowelsAvailable = 0;
                if(isPrizeActive('one_hit_wonder')) freeVowelsAvailable = 1;
                if(isPrizeActive('three_hit_boost')) freeVowelsAvailable = 2;
                if (gameState.vowelsPurchasedThisRound < freeVowelsAvailable) return 0;
                if (gameState.vowelsPurchasedThisRound < (3 + freeVowelsAvailable)) return 250;
                return 1000;
            }
            
            function updateAlphabetPanel() {
                if (!gameState) return;
                const container = gameState.inMainPrizeSelection ? mainPrizeAlphabetContainer : alphabetPanel;
                document.querySelectorAll('.alphabet-key').forEach(key => {
                    if (!container.contains(key)) return;

                    const letter = key.dataset.letter;
                    const isVowel = VOWELS.includes(letter);
                    let isDisabled = false;

                    if (gameState.inMainPrizeSelection) {
                        const isSelected = gameState.guessedLetters.includes(letter);
                        const consonantsFull = !isVowel && gameState.mainPrizeConsonants.length >= 5;
                        const vowelsFull = isVowel && gameState.mainPrizeVowels.length >= 1;
                        isDisabled = isSelected || consonantsFull || vowelsFull;
                    } else {
                        isDisabled = !gameState.gameInProgress || gameState.guessedLetters.includes(letter) || gameState.isSpinning;
                        if (isVowel) {
                            const cost = getCurrentVowelCost();
                            isDisabled = isDisabled || gameState.awaitingConsonant || gameState.isDoubleOrNothingTurn || (gameState.vowelsPurchasedThisRound >= 10) || (gameState.roundWinnings < cost && !gameState.hasFreeVowel);
                        } else { 
                            isDisabled = isDisabled || (!gameState.awaitingConsonant && !gameState.isDoubleOrNothingTurn);
                        }
                    }
                    key.disabled = isDisabled;
                });
            }
            
            function getSegmentsForRound(round) {
                let baseSegments = wheelSegmentsR1;
                if(round >= 2 && round < 5) baseSegments = wheelSegmentsR2;
                if(round >= 5) baseSegments = wheelSegmentsR3;
                let segments = JSON.parse(JSON.stringify(baseSegments));

                if(round === 3) segments[0] = { label: 'INGYEN MÃNHANGZÃ', value: 'free_vowel', color: '#81C784' };
                if(round === 4) segments[4] = { label: 'SEGÃTSÃG', value: 'assistance', color: '#64B5F6' };
                if(round === 5) segments[8] = { label: 'FELEZÅ', value: 'halver', color: 'var(--halver-orange)' };
                if(round === 6) segments[7] = { label: '+10.000', value: 10000, color: '#FFD54F', isBonus: true };
                if(round === 7) segments[4] = { label: '1600', value: 1600, color: '#BA68C8' };
                if(round === 8) segments[3] = { label: 'MEGLEPETÃS', value: 'surprise', color: 'var(--surprise-purple)' };
                if(round === 9) segments = [ { label: 'CSÅD', value: 'bankrupt', color: '#37474F' }, { label: '7500', value: 7500, color: '#FFEE58' }, { label: 'FELEZÅ', value: 'halver', color: 'var(--halver-orange)' }, { label: '1500', value: 1500, color: '#F06292' }, { label: 'KÃLÃNDÃJ', value: 'special_prize', color: '#B39DDB' }, { label: '2500', value: 2500, color: '#9CCC65' }, { label: 'CSÅD', value: 'bankrupt', color: '#37474F' }, { label: '4000', value: 4000, color: '#D4E157' }, { label: 'DUPLA/SEMMI', value: 'double_or_nothing', color: '#5C6BC0'}, { label: '3000', value: 3000, color: '#FFB74D' }, { label: '+10000', value: 10000, color: '#42A5F5', isBonus: true }, { label: '5000', value: 5000, color: '#E91E63' } ];
                if(round === 10) segments = [ { label: '+10000', value: 10000, color: '#42A5F5', isBonus: true }, { label: '5000', value: 5000, color: '#FFEE58' }, { label: '4500', value: 4500, color: '#BA68C8' }, { label: '3000', value: 3000, color: '#D4E157' }, { label: 'KÃLÃNDÃJ', value: 'special_prize', color: '#B39DDB' }, { label: '4000', value: 4000, color: '#9CCC65' }, { label: 'INGYEN MÃNHANGZÃ', value: 'free_vowel', color: '#81C784' }, { label: '7500', value: 7500, color: '#FFCA28' }, { label: 'SEGÃTSÃG', value: 'assistance', color: '#64B5F6' }, { label: '2500', value: 2500, color: '#FFB74D' }, { label: '+7500', value: 7500, color: '#42A5F5', isBonus: true }, { label: 'MEGLEPETÃS', value: 'surprise', color: 'var(--surprise-purple)' } ];
                
                if (gameState.specialPrizeWon) {
                    const prizeIndex = segments.findIndex(s => s.value === 'special_prize');
                    if (prizeIndex !== -1) segments[prizeIndex] = { label: '2000', value: 2000, color: '#4DB6AC' };
                }
                
                if (isPrizeActive('four_hit_no_bankrupt')) {
                    segments = segments.filter(s => s.value !== 'bankrupt');
                }

                return segments;
            }

             function polarToCartesian(cx, cy, r, angle) {
                const rad = (angle - 90) * Math.PI / 180.0;
                return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) };
            }
            
            function drawWheel(round) {
                const segments = getSegmentsForRound(round);
                const numSegments = segments.length;
                wheel.innerHTML = '';
                
                const bgCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                bgCircle.setAttribute("cx", 50);
                bgCircle.setAttribute("cy", 50);
                bgCircle.setAttribute("r", 50);
                bgCircle.setAttribute("fill", "#3F51B5");
                wheel.appendChild(bgCircle);

                for (let i = 0; i < numSegments; i++) {
                    const segment = segments[i];
                    const startAngle = i * (360 / numSegments);
                    const endAngle = (i + 1) * (360 / numSegments);
                    const start = polarToCartesian(50, 50, 50, endAngle);
                    const end = polarToCartesian(50, 50, 50, startAngle);
                    
                    const d = `M ${start.x} ${start.y} A 50 50 0 ${endAngle - startAngle <= 180 ? "0" : "1"} 0 ${end.x} ${end.y} L 50 50 Z`;
                    
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", d);
                    path.setAttribute("fill", segment.color.startsWith('var') ? `var(--${segment.color.split('--')[1].slice(0, -1)})` : segment.color);
                    path.setAttribute("stroke", "rgba(0,0,0,0.4)");
                    path.setAttribute("stroke-width", "0.5");
                    path.id = `wheel-segment-${i}`;
                    wheel.appendChild(path);

                    const textAngle = startAngle + (360 / numSegments) / 2;
                    let textRadiusMultiplier = 0.7;
                    if (segment.label.length > 10) textRadiusMultiplier = 0.65;
                    const textPos = polarToCartesian(50, 50, 50 * textRadiusMultiplier, textAngle);
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", textPos.x);
                    text.setAttribute("y", textPos.y);
                    text.setAttribute("text-anchor", "middle");
                    text.setAttribute("dominant-baseline", "middle");
                    text.setAttribute("font-family", "Montserrat, sans-serif");
                    text.setAttribute("font-weight", "700");
                    text.setAttribute("font-size", "4.5px");
                    text.setAttribute("fill", (typeof segment.value === 'string' || segment.isBonus) ? 'white' : 'black');
                    text.setAttribute("transform", `rotate(${textAngle + 90} ${textPos.x} ${textPos.y})`);
                    
                    const words = segment.label.split(' ');
                    if (words.length > 1) {
                         words.forEach((word, index) => {
                            const tspan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                            tspan.setAttribute("x", textPos.x);
                            tspan.setAttribute("dy", `${index === 0 ? -0.5 * (words.length - 1) * 4.8 : 4.8}px`);
                            tspan.textContent = word;
                            text.appendChild(tspan);
                        });
                    } else {
                        text.textContent = segment.label;
                    }
                    wheel.appendChild(text);
                }
            }
            
            function updateUI() {
                if (!gameState) return;
                scoreDisplay.textContent = `${gameState.playerScore.toLocaleString('hu-HU')} Ft`;
                hourlyWinningsDisplay.textContent = `${gameState.hourlyWinnings.toLocaleString('hu-HU')} Ft`;
                
                let roundWinningsText = `${gameState.roundWinnings.toLocaleString('hu-HU')} Ft`;
                if(isSunday && gameState.currentBet > 0){
                    roundWinningsText = `${gameState.roundWinnings.toLocaleString('hu-HU')} / -${gameState.currentBet.toLocaleString('hu-HU')} Ft`;
                }
                roundWinningsDisplay.textContent = roundWinningsText;

                if(gameState.totalRounds > 0 && gameState.gameInProgress){
                    roundInfoContainer.style.display = 'flex';
                    roundDisplay.textContent = `FordulÃ³: ${gameState.currentRound}/${gameState.totalRounds}`;
                    const date = new Date(gameState.puzzleHourId * 60 * 60 * 1000);
                    hourBlockDisplay.textContent = `AdÃ¡s: ${date.getHours()}:00`;
                } else {
                    roundInfoContainer.style.display = 'none';
                }

                wonPrizeContainer.style.display = gameState.wonPrizes.length > 0 ? 'flex' : 'none';
                if (gameState.wonPrizes.length > 0) {
                    wonPrizeName.textContent = gameState.wonPrizes.join(', ');
                }
                
                freeVowelIndicator.style.display = gameState.hasFreeVowel ? 'block' : 'none';
                
                const buttonsToDisable = (!gameState.gameInProgress || gameState.isSpinning || gameState.awaitingConsonant || gameState.isDoubleOrNothingTurn || gameState.inMainPrizeSelection);

                wheelCenterButton.disabled = buttonsToDisable || gameState.noMoreConsonants || gameState.isPoweringUp;
                if(gameState.isPoweringUp) wheelCenterButton.disabled = false;
                
                [solveButton, solveButtonDesktop].forEach(btn => btn.disabled = buttonsToDisable);
                [nyero21Button, nyero21ButtonDesktop].forEach(btn => btn.disabled = !gameState.gameInProgress || isSunday || gameState.inMainPrizeSelection);
                [transferButton, transferButtonDesktop].forEach(btn => btn.disabled = buttonsToDisable || gameState.transferUsedThisHour || isSunday || gameState.playerScore <= 0);
                [lottoButton, lottoButtonDesktop].forEach(btn => btn.disabled = !gameState.gameInProgress || gameState.inMainPrizeSelection);

                lottoBajnokIcon.style.display = isPrizeActive('lotto_bajnok') ? 'block' : 'none';
                
                updateAlphabetPanel();
                updateMainPrizeProgress();
                updateLottoPrizeHud();
                updatePrizeChestHud();
            }
            
            function updateLottoPrizeHud() {
                const prizes = getActiveBonuses();
                if (prizes.length > 0) {
                    lottoPrizeHud.style.display = 'flex';
                    lottoPrizeCount.textContent = prizes.length;
                } else {
                    lottoPrizeHud.style.display = 'none';
                }
            }
            
            function updatePrizeChestHud() {
                const inventory = getPrizeInventory();
                if(inventory.length > 0) {
                    prizeChestHud.style.display = 'flex';
                    prizeChestCount.textContent = inventory.length;
                } else {
                    prizeChestHud.style.display = 'none';
                }
            }

            function updateMainPrizeProgress() {
                if (!gameState || isSunday || !gameState.gameInProgress || gameState.currentRound > gameState.totalRounds || gameState.inMainPrizeSelection) {
                    mainPrizeProgress.style.display = 'none';
                    return;
                }

                mainPrizeProgress.style.display = 'block';
                if (gameState.hourlyWinnings >= MAIN_PRIZE_THRESHOLD) {
                    mainPrizeProgress.innerHTML = `ð <strong>Jogosult vagy a FÅdÃ­j JÃ¡tÃ©kra!</strong>`;
                    if (!gameState.mainPrizeQualifiedNotified) {
                        updateHostMessage(getRandomMessage('main_prize_qualified', { threshold: MAIN_PRIZE_THRESHOLD.toLocaleString('hu-HU') }), true);
                        gameState.mainPrizeQualifiedNotified = true;
                    }
                } else {
                    const needed = MAIN_PRIZE_THRESHOLD - gameState.hourlyWinnings;
                    mainPrizeProgress.innerHTML = `A FÅdÃ­j JÃ¡tÃ©khoz hiÃ¡nyzik mÃ©g: <strong>${needed.toLocaleString('hu-HU')} Ft</strong>`;
                }
            }
            
            function showModal({title, text, showInput = false, inputType='text', confirmText = 'Rendben', cancelText = 'MÃ©gse', showCancel = true}) {
                return new Promise((resolve, reject) => {
                    modalTitle.textContent = title;
                    modalText.innerHTML = text;
                    solveInput.type = inputType;
                    solveInput.style.display = showInput ? 'block' : 'none';
                    if(showInput) {
                      solveInput.value = '';
                      setTimeout(() => solveInput.focus(), 100);
                    }
                    
                    modalButtons.innerHTML = ''; 

                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'modal-btn confirm';
                    confirmBtn.textContent = confirmText;
                    confirmBtn.onclick = () => {
                        closeModal(solveInput.style.display !== 'none' ? solveInput.value : true);
                    };
                    modalButtons.appendChild(confirmBtn);

                    if (showCancel) {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'modal-btn cancel';
                        cancelBtn.textContent = cancelText;
                        cancelBtn.onclick = () => closeModal(false);
                        modalButtons.appendChild(cancelBtn);
                    }
                    
                    modalOverlay.classList.add('visible');
                    currentModal = { resolve, reject };
                });
            }

            function closeModal(value) {
                modalOverlay.classList.remove('visible');
                if (value !== false && currentModal.resolve) {
                    currentModal.resolve(value);
                } else if (value === false && currentModal.reject) {
                    currentModal.reject();
                }
                currentModal = { resolve: null, reject: null };
            }
            
            function spinWheel(power) {
                if (gameState.isSpinning) return;
                gameState.isSpinning = true;
                gameState.currentSpinValue = null;
                updateUI();
                updateHostMessage(getRandomMessage('spinning'));

                const baseRotations = 3;
                const powerRotation = power * 4;
                const randomExtraRotation = Math.random();
                const totalRotation = (baseRotations + powerRotation + randomExtraRotation) * 360;
                const currentRotation = parseFloat(wheel.dataset.rotation || 0);
                const newRotation = currentRotation + totalRotation;
                wheel.style.transform = `rotate(${newRotation}deg)`;
                wheel.dataset.rotation = newRotation;
                
                setTimeout(() => {
                    try {
                        gameState.isSpinning = false;
                        const segments = getSegmentsForRound(gameState.currentRound);
                        const numSegments = segments.length;
                        const segmentAngle = 360 / numSegments;
                        
                        const finalAngle = newRotation % 360;
                        const pointerAngle = (360 - finalAngle) % 360; 
                        const segmentIndex = Math.floor(pointerAngle / segmentAngle);
                        
                        const result = segments[segmentIndex];
                        
                        const segmentPath = document.getElementById(`wheel-segment-${segmentIndex}`);
                        if (segmentPath) {
                            segmentPath.classList.add('flashing-segment');
                            setTimeout(() => segmentPath.classList.remove('flashing-segment'), 900);
                        }
                        
                        setTimeout(() => handleSpinResult(result), 500);
                        
                        boosterBar.style.transition = 'stroke-dashoffset 0.5s ease-out';
                        boosterBar.style.strokeDashoffset = circumference;
                        setTimeout(()=> { boosterBar.style.transition = 'none' }, 500);
                    } catch (error) {
                        console.error("Hiba a pÃ¶rgetÃ©s feldolgozÃ¡sa kÃ¶zben:", error);
                        updateHostMessage("HoppÃ¡, egy technikai hiba tÃ¶rtÃ©nt! A 'Hiba ÃtugrÃ¡sa' gombbal folytathatod.", true);
                        skipErrorBtn.style.display = 'block';
                    }
                }, 5000);
            }
            
            async function solvePuzzle(autoSolve = false) {
                const puzzleData = allPuzzles[hourlyPuzzleIndices[gameState.currentRound - 1]];
                let attempt = '';
                const normalizeText = (text) => text.toUpperCase().replace(/[^A-ZÃÃÃÃÃÅUÃÃÅ°0-9]/g, '');

                const cleanPuzzle = normalizeText(puzzleData.puzzle);

                if (!autoSolve) {
                    try {
                        attempt = await showModal({
                            title: 'MegfejtÃ©s', text: 'Na, mi a megfejtÃ©s?', showInput: true, inputType: 'text', confirmText: 'BekÃ¼ldÃ¶m!'
                        });
                        if (attempt === false) return;
                    } catch { return; }
                } else {
                    attempt = puzzleData.puzzle;
                }
                const cleanAttempt = normalizeText(attempt);
                const isGoldenRound = isPrizeActive('lotto_bajnok');

                if (cleanAttempt === cleanPuzzle) {
                    if(!autoSolve) {
                        const unrevealedTiles = document.querySelectorAll('.puzzle-tile[data-letter]:not(.revealed)');
                        for (const tile of unrevealedTiles) {
                            tile.classList.add('revealed');
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                    
                    let solveBonus = SOLVE_BONUSES[Math.min(gameState.currentRound - 1, SOLVE_BONUSES.length - 1)];
                    if (gameState.isSolveBonusDoubled) solveBonus *= 2;
                    let roundWinnings = gameState.roundWinnings;
                    
                    if(isGoldenRound) {
                        solveBonus *= 2;
                        roundWinnings *= 2;
                    }

                    let totalGained = roundWinnings + solveBonus;
                    
                    if(isSunday){
                        gameState.playerScore += totalGained + gameState.currentBet; 
                        updateHostMessage(getRandomMessage('solve_sunday_success', {
                            bet: gameState.currentBet.toLocaleString('hu-HU'),
                            totalGained: totalGained.toLocaleString('hu-HU')
                        }), true);
                    } else {
                        gameState.hourlyWinnings += totalGained;
                        gameState.playerScore += totalGained;
                        updateHostMessage(getRandomMessage(isGoldenRound ? 'solve_golden_success' : 'solve_success', {totalGained: totalGained.toLocaleString('hu-HU')}));
                    }
                    saveWeeklyScore(gameState.playerScore);
                    
                    gameState.currentRound++;
                    if (gameState.currentRound <= gameState.totalRounds) {
                        setTimeout(() => startNewRound(), 5000); 
                    } else {
                        gameState.gameInProgress = false;
                        setTimeout(handleEndOfHour, 5000);
                    }
                } else {
                    if(gameState.hasFreeSolveAttempt) {
                        updateHostMessage("Sajnos nem ez a megfejtÃ©s, de mivel ingyen kÃ­sÃ©rleted volt, nem vesztettÃ©l semmit!", true);
                        gameState.hasFreeSolveAttempt = false;
                        return;
                    }
                    const penalty = Math.max(500, Math.floor(gameState.roundWinnings * 0.20));
                    gameState.roundWinnings = Math.max(0, gameState.roundWinnings - penalty);
                    updateHostMessage(getRandomMessage('solve_fail', {penalty: penalty.toLocaleString('hu-HU')}), true);
                    updateUI();
                }
            }

            async function startMainPrizeGame(isDevTest = false) {
                 gameState.isDevMainPrizeTest = isDevTest;
                 const mainPrizePuzzles = allPuzzles.filter(p => p.category === 'FÅdÃ­j FeladvÃ¡ny');
                 if (mainPrizePuzzles.length === 0) {
                     alert("Hiba: Nincs FÅdÃ­j FeladvÃ¡ny a rendszerben!");
                     if(!isDevTest) gameOver();
                     return;
                 }
                 if (!gameState.puzzleHourId) {
                     gameState.puzzleHourId = Math.floor(Date.now() / (1000 * 60 * 60));
                 }
                 const mainPrizePuzzle = mainPrizePuzzles[gameState.puzzleHourId % mainPrizePuzzles.length];
                 
                 if (isDevTest) {
                     gameState.mainPrizeStake = MAIN_PRIZE_THRESHOLD;
                     mainPrizeModal.querySelector('.dev-mode-indicator').style.display = 'block';
                 } else {
                     gameState.mainPrizeStake = gameState.hourlyWinnings;
                     mainPrizeModal.querySelector('.dev-mode-indicator').style.display = 'none';
                 }

                 gameState.inMainPrizeSelection = true;
                 gameState.guessedLetters = [];
                 gameState.mainPrizeConsonants = [];
                 gameState.mainPrizeVowels = [];
                 
                 mainPrizeModal.style.display = 'flex';
                 createAlphabetPanel(mainPrizeAlphabetContainer);
                 
                 mainPrizeTitle.textContent = "FÅdÃ­j - BetÅ±vÃ¡lasztÃ¡s";
                 mainPrizeCategory.textContent = "VÃ¡lassz 5 mÃ¡ssalhangzÃ³t Ã©s 1 magÃ¡nhangzÃ³t";
                 mainPrizeInstructions.innerHTML = "Ãrd be a megfejtÃ©st, mielÅtt lejÃ¡r az idÅ!";
                 mainPrizeInstructions.style.display = 'none';
                 mainPrizeSolveInput.style.display = 'none';
                 mainPrizeConfirmBtn.style.display = 'none';
                 mainPrizeCloseBtn.style.display = 'none';
                 mainPrizeFinalAnswer.style.display = 'none';
                 mainPrizeSelectConfirmBtn.style.display = 'inline-flex';
                 mainPrizeSelectConfirmBtn.disabled = true;
                 mainPrizeTimer.style.display = 'none';
                 mainPrizeBoard.innerHTML = '';
                 setupPuzzleBoard(mainPrizeBoard, mainPrizePuzzle);
                 mainPrizeGivenLetters.innerHTML = '';
                 updateUI();
            }

            function handleMainPrizeLetterSelection(letter) {
                if (!gameState.inMainPrizeSelection || gameState.guessedLetters.includes(letter)) return;
                
                const isVowel = VOWELS.includes(letter);
                
                if (isVowel && gameState.mainPrizeVowels.length < 1) {
                    gameState.mainPrizeVowels.push(letter);
                    gameState.guessedLetters.push(letter);
                } else if (!isVowel && gameState.mainPrizeConsonants.length < 5) {
                    gameState.mainPrizeConsonants.push(letter);
                    gameState.guessedLetters.push(letter);
                }

                updateAlphabetPanel();

                const consonantsLeft = 5 - gameState.mainPrizeConsonants.length;
                const vowelsLeft = 1 - gameState.mainPrizeVowels.length;
                mainPrizeCategory.textContent = `VÃ¡lassz mÃ©g: ${consonantsLeft} mÃ¡ssalhangzÃ³t, ${vowelsLeft} magÃ¡nhangzÃ³t`;
                
                if (consonantsLeft === 0 && vowelsLeft === 0) {
                     mainPrizeCategory.textContent = 'Minden betÅ± kivÃ¡lasztva! KÃ©szen Ã¡llsz?';
                     mainPrizeSelectConfirmBtn.disabled = false;
                }
            }

            function runMainPrizeCountdown() {
                 mainPrizeSelectConfirmBtn.style.display = 'none';
                 mainPrizeTitle.textContent = "FÅdÃ­j JÃ¡tÃ©k";
                 const mainPrizePuzzles = allPuzzles.filter(p => p.category === 'FÅdÃ­j FeladvÃ¡ny');
                 const mainPrizePuzzle = mainPrizePuzzles[gameState.puzzleHourId % mainPrizePuzzles.length];
                 mainPrizeCategory.textContent = mainPrizePuzzle.category;
                 mainPrizeAlphabetContainer.style.display = 'none';

                 mainPrizeInstructions.style.display = 'block';
                 mainPrizeSolveInput.style.display = 'block';
                 mainPrizeSolveInput.value = '';
                 mainPrizeConfirmBtn.style.display = 'inline-flex';
                 mainPrizeTimer.style.display = 'block';

                 const chosenLetters = [...gameState.mainPrizeConsonants, ...gameState.mainPrizeVowels];
                 mainPrizeGivenLetters.textContent = `A vÃ¡lasztott betÅ±id: ${chosenLetters.join(', ')}`;
                 
                 chosenLetters.forEach(letter => {
                     mainPrizeBoard.querySelectorAll(`.puzzle-tile[data-letter="${letter}"]`).forEach(tile => tile.classList.add('revealed'));
                 });
                     
                 let timeLeft = MAIN_PRIZE_TIME * 10;
                 let hintGiven = false;
                 mainPrizeTimer.textContent = (timeLeft / 10).toFixed(1);
                 mainPrizeTimer.classList.remove('timer-low');
                 mainPrizeSolveInput.disabled = false;
                 mainPrizeConfirmBtn.disabled = false;
                 setTimeout(() => mainPrizeSolveInput.focus(), 100);
                 
                 mainPrizeTimerInterval = setInterval(() => {
                     timeLeft--;
                     mainPrizeTimer.textContent = (timeLeft / 10).toFixed(1);
                     
                     if (!hintGiven && timeLeft <= 150) { // 15 seconds
                        hintGiven = true;
                        if (mainPrizePuzzle.hint) {
                            mainPrizeInstructions.innerHTML = `SegÃ­tsÃ©g: Ez egy <strong>${mainPrizePuzzle.hint}</strong>`;
                        }
                     }

                     if(timeLeft <= 100 && !mainPrizeTimer.classList.contains('timer-low')) {
                        mainPrizeTimer.classList.add('timer-low');
                     }
                     if(timeLeft <= 0) {
                        endMainPrizeGame(false, true);
                     }
                 }, 100);
            }
            
            function endMainPrizeGame(isWin, isTimeout = false) {
                clearInterval(mainPrizeTimerInterval);
                mainPrizeSolveInput.disabled = true;
                mainPrizeConfirmBtn.disabled = true;
                const stake = gameState.mainPrizeStake;
                const isDevTest = gameState.isDevMainPrizeTest;
                
                if (isWin) {
                    const winnings = stake; 
                    if (!isDevTest) {
                       gameState.playerScore += winnings; 
                       gameState.hourlyWinnings += winnings;
                    }
                    const totalDisplay = (stake + winnings).toLocaleString('hu-HU');
                    updateHostMessage(getRandomMessage('main_prize_win', { winnings: totalDisplay }) + (isDevTest ? ' (TESZT)' : ''), true);
                } else {
                    if (!isDevTest) {
                        gameState.playerScore -= stake;
                        gameState.hourlyWinnings = 0;
                    }
                    updateHostMessage(getRandomMessage(isTimeout ? 'main_prize_lose_timeout' : 'main_prize_lose') + (isDevTest ? ' (TESZT)' : ''), true);

                    const mainPrizePuzzles = allPuzzles.filter(p => p.category === 'FÅdÃ­j FeladvÃ¡ny');
                    const mainPrizePuzzle = mainPrizePuzzles[gameState.puzzleHourId % mainPrizePuzzles.length];
                    mainPrizeFinalAnswer.textContent = `A helyes megfejtÃ©s: ${mainPrizePuzzle.puzzle}`;
                    mainPrizeFinalAnswer.style.display = 'block';
                }
                
                mainPrizeCloseBtn.style.display = 'inline-flex';
                
                if (!isDevTest) {
                    gameState.hourlyWinnings = 0;
                    saveWeeklyScore(gameState.playerScore);
                }
                gameState.mainPrizeStake = 0;
            }

            function forceEndMainPrize() {
                mainPrizeModal.style.display = 'none';
                gameState.inMainPrizeSelection = false;
                document.getElementById('puzzle-section').insertBefore(alphabetPanel, document.getElementById('desktop-action-buttons'));
                createAlphabetPanel();
                if (!gameState.isDevMainPrizeTest) {
                     gameOver();
                } else {
                    gameState.isDevMainPrizeTest = false;
                }
            }

            function launchNyero21(isDevTest = false) {
                isDevModeActive = isDevTest;
                let playsLeft = MINIGAME_PLAYS_PER_HOUR;
                const currentScore = gameState ? gameState.playerScore : loadWeeklyScore();

                if (!isDevModeActive) {
                    if (!gameState || !gameState.gameInProgress) return;
                    const currentHourId = Math.floor(Date.now() / (1000 * 60 * 60));
                    const lastPlayedHour = localStorage.getItem('nyero21HourId');

                    if (currentHourId.toString() !== lastPlayedHour) {
                        gameState.nyero21PlaysThisHour = 0;
                        localStorage.setItem('nyero21HourId', currentHourId.toString());
                        localStorage.setItem('nyero21Plays', '0');
                    } else {
                        gameState.nyero21PlaysThisHour = parseInt(localStorage.getItem('nyero21Plays') || '0', 10);
                    }
                    playsLeft = MINIGAME_PLAYS_PER_HOUR - gameState.nyero21PlaysThisHour;

                    if (playsLeft <= 0) {
                        alert("Ebben az Ã³rÃ¡ban mÃ¡r nem jÃ¡tszhatod a NyerÅ21-et. Gyere vissza kÃ©sÅbb!");
                        return;
                    }
                }

                nyero21StakingArea.style.display = 'block';
                nyero21GameArea.style.display = 'none';
                nyero21PlayerBalance.textContent = currentScore.toLocaleString('hu-HU');
                nyero21PlaysLeft.textContent = isDevModeActive ? "TESZT MÃD: KorlÃ¡tlan jÃ¡tÃ©k." : `Ebben az Ã³rÃ¡ban mÃ©g ${playsLeft} alkalommal jÃ¡tszhatsz.`;
                nyero21StakeInput.value = '';
                nyero21Modal.querySelector('.dev-mode-indicator').style.display = isDevModeActive ? 'block' : 'none';
                nyero21Modal.classList.add('visible');
            }

            function startNyero21() {
                const stake = isDevModeActive ? 10000 : parseInt(nyero21StakeInput.value, 10);
                const currentScore = gameState ? gameState.playerScore : loadWeeklyScore();

                if (!isDevModeActive) {
                    if (isNaN(stake) || stake <= 0) {
                        alert("KÃ©rlek, adj meg egy Ã©rvÃ©nyes, pozitÃ­v tÃ©tet!");
                        return;
                    }
                    if (stake > currentScore) {
                        alert("Nincs elÃ©g zsetonod ehhez a tÃ©thez!");
                        return;
                    }
                }

                nyero21State = {
                    stake: stake,
                    deck: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11].sort(() => 0.5 - Math.random()),
                    playerSum: 0,
                    cardsDrawn: 0,
                    gameOver: false
                };
                
                const winPrize = stake * 2;
                const jackpotPrize = stake * 5;
                const balanceAfterStake = isDevModeActive ? currentScore : currentScore - stake;
                nyero21InfoBar.innerHTML = `
                    Feltett tÃ©t: <strong>${stake.toLocaleString('hu-HU')} Ft</strong><br>
                    Jelenlegi egyenleg: <strong>${balanceAfterStake.toLocaleString('hu-HU')} Ft</strong><br>
                    VÃ¡rhatÃ³ nyeremÃ©ny (18-20): <strong>${winPrize.toLocaleString('hu-HU')} Ft</strong><br>
                    VÃ¡rhatÃ³ nyeremÃ©ny (21): <strong>${jackpotPrize.toLocaleString('hu-HU')} Ft</strong>
                `;

                if (!isDevModeActive) {
                    gameState.playerScore -= stake;
                    saveWeeklyScore(gameState.playerScore);
                    updateUI();
                }

                nyero21StakingArea.style.display = 'none';
                nyero21GameArea.style.display = 'block';
                nyero21PlayerScore.textContent = '0';
                nyero21ResultMessage.textContent = '';
                nyero21ResultMessage.className = 'nyero21-result-message';
                nyero21HitBtn.style.display = 'inline-flex';
                nyero21StandBtn.style.display = 'inline-flex';
                nyero21StandBtn.disabled = true;
                nyero21NewGameBtn.style.display = 'none';
                nyero21CloseBtn.style.display = 'none';

                nyero21CardDeck.innerHTML = '';
                nyero21State.deck.forEach((value) => {
                    const card = document.createElement('div');
                    card.className = 'nyero21-card';
                    card.dataset.value = value;
                    card.innerHTML = `<div class="nyero21-card-face nyero21-card-back"></div><div class="nyero21-card-face nyero21-card-front">${value}</div>`;
                    card.addEventListener('click', () => drawCard(card));
                    nyero21CardDeck.appendChild(card);
                });
            }

            function drawCard(cardElement) {
                if (nyero21State.gameOver || cardElement.classList.contains('flipped')) return;

                cardElement.classList.add('flipped');
                const value = parseInt(cardElement.dataset.value, 10);
                nyero21State.playerSum += value;
                nyero21State.cardsDrawn++;
                
                nyero21PlayerScore.textContent = nyero21State.playerSum;
                if (nyero21State.cardsDrawn >= 2) {
                    nyero21StandBtn.disabled = false;
                }
                
                if (nyero21State.playerSum > 21) {
                    endNyero21('lose', 'CSÅD! TÃºl sok!');
                } else if (nyero21State.playerSum === 21) {
                     endNyero21('jackpot', 'NYERÅ21! JACKPOT!');
                }
            }
            
            function standNyero21() {
                if(nyero21State.playerSum >= 18 && nyero21State.playerSum <= 20) {
                    endNyero21('win', 'NYERTÃL!');
                } else {
                    endNyero21('lose', 'TÃºl kevÃ©s, a hÃ¡z nyert.');
                }
            }

            function endNyero21(result, message) {
                if (nyero21State.gameOver) return;
                nyero21State.gameOver = true;
                nyero21HitBtn.style.display = 'none';
                nyero21StandBtn.style.display = 'none';
                
                let winnings = 0;
                if (result === 'win') {
                    winnings = nyero21State.stake * 2;
                    nyero21ResultMessage.classList.add('win');
                } else if (result === 'jackpot') {
                    winnings = nyero21State.stake * 5;
                    nyero21ResultMessage.classList.add('win');
                } else {
                    nyero21ResultMessage.classList.add('lose');
                }
                
                nyero21ResultMessage.textContent = message;
                if(winnings > 0) {
                     nyero21ResultMessage.textContent += ` NyeremÃ©ny: ${winnings.toLocaleString('hu-HU')} Ft`;
                }

                if (!isDevModeActive) {
                    gameState.playerScore += winnings;
                    saveWeeklyScore(gameState.playerScore);
                    updateUI();
                    gameState.nyero21PlaysThisHour++;
                    localStorage.setItem('nyero21Plays', gameState.nyero21PlaysThisHour.toString());
                } else {
                    nyero21ResultMessage.textContent += " (Teszt NyeremÃ©ny)";
                }

                const playsLeft = MINIGAME_PLAYS_PER_HOUR - (gameState ? gameState.nyero21PlaysThisHour : 0);
                
                if (isDevModeActive || playsLeft > 0) {
                    nyero21NewGameBtn.style.display = 'inline-flex';
                }
                nyero21CloseBtn.style.display = 'inline-flex';

                const unflippedCards = document.querySelectorAll('.nyero21-card:not(.flipped)');
                unflippedCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add('flipped');
                    }, 200 * (index + 1));
                });
            }

            function togglePowerMeter() {
                if (wheelCenterButton.disabled && !gameState.isPoweringUp) return;
                
                if (!gameState.isPoweringUp) {
                    gameState.isPoweringUp = true;
                    wheelCenterText.textContent = "Stop";
                    updateHostMessage(getRandomMessage('power_up'));
                    
                    cancelAnimationFrame(powerAnimationId);
                    let startTime = null;
                    
                    const animatePower = (timestamp) => {
                        if (!startTime) startTime = timestamp;
                        const elapsed = timestamp - startTime;
                        const power = (Math.sin(elapsed / 600) + 1) / 2;
                        gameState.currentPower = power;
                        
                        const offset = circumference * (1 - power);
                        boosterBar.style.strokeDashoffset = offset;
                        
                        powerAnimationId = requestAnimationFrame(animatePower);
                    };
                    requestAnimationFrame(animatePower);
                    
                } else {
                    gameState.isPoweringUp = false;
                    cancelAnimationFrame(powerAnimationId);
                    wheelCenterText.textContent = "PÃ¶rget";
                    spinWheel(gameState.currentPower);
                }
            }
             function checkAllConsonantsGuessed() {
                const currentPuzzle = allPuzzles[hourlyPuzzleIndices[gameState.currentRound - 1]].puzzle.toUpperCase();
                const uniqueChars = [...new Set(currentPuzzle.split(''))];
                const consonantsInPuzzle = uniqueChars.filter(char => !VOWELS.includes(char) && FULL_ALPHABET.includes(char));

                const allGuessed = consonantsInPuzzle.every(consonant => gameState.guessedLetters.includes(consonant));

                if (allGuessed && !gameState.noMoreConsonants) {
                    gameState.noMoreConsonants = true;
                    updateHostMessage(getRandomMessage('no_more_consonants'), true);
                    updateUI();
                }
             }
            
            async function handleSpinResult(result) {
                gameState.awaitingConsonant = false;
                
                if (result.isBonus) {
                    updateHostMessage(getRandomMessage('bonus_points', {value: result.value.toLocaleString('hu-HU')}), true);
                    gameState.roundWinnings += result.value;
                    endTurn();
                    return;
                }

                switch(result.value) {
                    case 'bankrupt':
                        if (gameState.hasBankruptProtection) {
                            updateHostMessage("CSÅD! De a meglepetÃ©skÃ©nt kapott vÃ©delmed megmentett! Nem vesztettÃ©l semmit.", true);
                            gameState.hasBankruptProtection = false;
                        } else if (isPrizeActive('one_hit_wonder') || isPrizeActive('four_hit_no_bankrupt')) {
                           updateHostMessage("CSÅD! De a LottÃ³n nyert vÃ©delmed megmentett! Nem vesztettÃ©l semmit.", true);
                        } else if(isSunday){
                             updateHostMessage(getRandomMessage('bankrupt_sunday', {bet: gameState.currentBet.toLocaleString('hu-HU')}), true);
                             gameState.playerScore -= gameState.currentBet;
                             gameState.playerScore = Math.max(0, gameState.playerScore);
                             saveWeeklyScore(gameState.playerScore);
                             gameState.roundWinnings = 0;
                        } else {
                             updateHostMessage(getRandomMessage('bankrupt'), true);
                             gameState.roundWinnings = 0;
                        }
                        endTurn();
                        break;
                    case 'lose_turn':
                        updateHostMessage(getRandomMessage('lose_turn'), true);
                        endTurn();
                        break;
                    case 'double_or_nothing':
                        handleDoubleOrNothing();
                        break;
                    case 'special_prize':
                        await handleSpecialPrize();
                        break;
                    case 'free_vowel':
                        gameState.hasFreeVowel = true;
                        updateHostMessage(getRandomMessage('free_vowel_spin'), true);
                        endTurn();
                        break;
                    case 'assistance':
                        await handleAssistance();
                        break;
                    case 'halver':
                        const amountLost = gameState.roundWinnings - Math.floor(gameState.roundWinnings / 2);
                        gameState.halverAmountLostThisRound += amountLost;
                        updateHostMessage(getRandomMessage('halver_spin'), true);
                        gameState.roundWinnings = Math.floor(gameState.roundWinnings / 2);
                        endTurn();
                        break;
                    case 'surprise':
                        handleSurprise();
                        break;
                    default: 
                        gameState.currentSpinValue = result.value;
                        gameState.awaitingConsonant = true;
                        updateHostMessage(getRandomMessage('spin_result', {value: result.value.toLocaleString('hu-HU')}), true);
                        updateUI();
                        break;
                }
            }

            function handleSurprise() {
                const surprise = SURPRISE_EVENTS[Math.floor(Math.random() * SURPRISE_EVENTS.length)];
                updateHostMessage(surprise.text, true);
                if (surprise.execute) {
                    surprise.execute(gameState);
                } else {
                    endTurn();
                }
            }
            
            function showAutoHint() {
                const puzzleData = allPuzzles[hourlyPuzzleIndices[gameState.currentRound - 1]];
                if (!puzzleData.hints || puzzleData.hints.length === 0) return;

                let hintsToShow = [];
                let newHintAppeared = false;
                
                const currentHints = autoHintsContainer.innerHTML;

                if (gameState.consecutiveWrongConsonants >= 5 && puzzleData.hints[0] && !currentHints.includes(puzzleData.hints[0])) {
                    hintsToShow.push(`<strong>1. SegÃ­tsÃ©g:</strong> ${puzzleData.hints[0]}`);
                    newHintAppeared = true;
                }
                if (gameState.consecutiveWrongConsonants >= 10 && puzzleData.hints[1] && !currentHints.includes(puzzleData.hints[1])) {
                    hintsToShow.push(`<strong>2. SegÃ­tsÃ©g:</strong> ${puzzleData.hints[1]}`);
                    newHintAppeared = true;
                }

                if (newHintAppeared) {
                    const newContent = hintsToShow.join('<br><br>');
                    autoHintsContainer.innerHTML = currentHints ? `${currentHints}<br><br>${newContent}` : newContent;
                    autoHintsContainer.style.display = 'block';
                    autoHintsContainer.classList.add('hint-appearing');
                    setTimeout(() => autoHintsContainer.classList.remove('hint-appearing'), 1500);
                }
            }

            async function handleAssistance() {
                 if (isPrizeActive('lotto_bajnok')) {
                    updateHostMessage("LottÃ³BajnokkÃ©nt a segÃ­tsÃ©g ingyenes!", true);
                 }
                const puzzleStr = allPuzzles[hourlyPuzzleIndices[gameState.currentRound - 1]].puzzle.toUpperCase();
                const freq = {};
                for (const char of puzzleStr) {
                    if (!VOWELS.includes(char) && FULL_ALPHABET.includes(char) && !gameState.guessedLetters.includes(char)) {
                        freq[char] = (freq[char] || 0) + 1;
                    }
                }
                
                const mostFrequentChar = Object.keys(freq).sort((a,b) => freq[b] - freq[a])[0];

                if (mostFrequentChar) {
                    updateHostMessage(getRandomMessage('assistance_spin', {letter: mostFrequentChar}), true);
                    const foundCount = (puzzleStr.match(new RegExp(mostFrequentChar, "g")) || []).length;
                    gameState.guessedLetters.push(mostFrequentChar);
                    await revealAndCalculate(mostFrequentChar, false, foundCount, true); 
                } else {
                    updateHostMessage("SegÃ­tsÃ©g! De mÃ¡r minden mÃ¡ssalhangzÃ³t kitalÃ¡ltÃ¡l. Sebaj!", true);
                    endTurn();
                }
            }

            async function handleSpecialPrize() {
                const availablePrizes = SPECIAL_PRIZES.filter(p => !gameState.wonPrizes.includes(p.name));
                
                if (availablePrizes.length === 0) {
                    const cashAward = 50000;
                    gameState.roundWinnings += cashAward;
                    updateHostMessage(`MÃ¡r az Ã¶sszes kÃ¼lÃ¶ndÃ­jat bezsebelted! GratulÃ¡lunk! Jutalmad helyette <strong>${cashAward.toLocaleString('hu-HU')} Ft</strong>!`, true);
                    gameState.specialPrizeWon = true;
                    endTurn();
                    return;
                }
                
                const prize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
                const cashValue = Math.floor(prize.value / 2);
                
                try {
                    const choice = await showModal({
                        title: 'KÃ¼lÃ¶ndÃ­j!',
                        text: `GratulÃ¡lok, nyertÃ©l egy KÃ¼lÃ¶ndÃ­jat: <strong>${prize.name}</strong>!<br><br>VÃ¡laszthatsz: kÃ©red a tÃ¡rgyat, vagy inkÃ¡bb jÃ¶jjÃ¶n az Ã©rtÃ©kÃ©nek fele, <strong>${cashValue.toLocaleString('hu-HU')}&nbsp;Ft</strong>?`,
                        confirmText: 'KÃ©rem a cuccot!',
                        cancelText: `JÃ¶het a zseton (${cashValue.toLocaleString('hu-HU')} Ft)`,
                    });

                    if (choice) {
                        gameState.wonPrizes.push(prize.name);
                        updateHostMessage(`Remek vÃ¡lasztÃ¡s! A(z) <strong>${prize.name}</strong> mÃ¡r a tiÃ©d!`, true);
                    } else {
                         gameState.roundWinnings += cashValue;
                         updateHostMessage(`Okos dÃ¶ntÃ©s! <strong>${cashValue.toLocaleString('hu-HU')}&nbsp;Ft</strong> jÃ³vÃ¡Ã­rva!`, true);
                    }
                } catch { 
                     gameState.roundWinnings += cashValue;
                     updateHostMessage(`A biztos pÃ©nzt vÃ¡lasztottad, <strong>${cashValue.toLocaleString('hu-HU')}&nbsp;Ft</strong> jÃ³vÃ¡Ã­rva!`, true);
                }
                
                gameState.specialPrizeWon = true;
                endTurn();
            }
            
            async function handleTransfer() {
                if (gameState.transferUsedThisHour) {
                    alert("Ebben az Ã³rÃ¡ban mÃ¡r hasznÃ¡ltad az Ã¡tutalÃ¡st!");
                    return;
                }
                if (gameState.playerScore <= 0) {
                    alert("Nincs elÃ©g zsetonod az Ã¡tutalÃ¡shoz!");
                    return;
                }

                try {
                    const amountStr = await showModal({
                        title: 'Zseton ÃtutalÃ¡s',
                        text: `Mennyi zsetont szeretnÃ©l Ã¡tutalni az <strong>Ãsszes ZsetonodbÃ³l</strong> (${gameState.playerScore.toLocaleString('hu-HU')} Ft) az <strong>Ebben a kÃ¶rben</strong> lÃ©vÅ Ã¶sszeghez?<br><br>Maximum 10.000 Ft utalhatÃ³. Az utalÃ¡s dÃ­ja az Ã¶sszeg 10%-a.`,
                        showInput: true,
                        inputType: 'number',
                        confirmText: 'TovÃ¡bb',
                        cancelText: 'MÃ©gse'
                    });

                    const amount = parseInt(amountStr, 10);

                    if (isNaN(amount) || amount <= 0) {
                        if (amountStr !== false) alert("ÃrvÃ©nytelen Ã¶sszeg.");
                        return;
                    }
                    if (amount > 10000) {
                        alert("Maximum 10.000 Ft-ot utalhatsz Ã¡t.");
                        return;
                    }
                    
                    const fee = Math.ceil(amount * 0.1);
                    const totalCost = amount + fee;

                    if (totalCost > gameState.playerScore) {
                        alert(`Nincs elÃ©g zsetonod a ${amount.toLocaleString('hu-HU')} Ft-os utalÃ¡sra Ã©s annak ${fee.toLocaleString('hu-HU')} Ft-os dÃ­jÃ¡ra (Ã¶sszesen ${totalCost.toLocaleString('hu-HU')} Ft).`);
                        return;
                    }
                    
                    const confirmTransfer = await showModal({
                        title: 'ÃtutalÃ¡s MegerÅsÃ­tÃ©se',
                        text: `Ãtutalsz <strong>${amount.toLocaleString('hu-HU')} Ft</strong>-ot. <br>A tranzakciÃ³ dÃ­ja: <strong>${fee.toLocaleString('hu-HU')} Ft</strong>.<br>Teljes kÃ¶ltsÃ©g: <strong>${totalCost.toLocaleString('hu-HU')} Ft</strong>.<br><br>Biztosan folytatod?`,
                        confirmText: 'Igen, utalÃ¡s!',
                        cancelText: 'Nem'
                    });

                    if (confirmTransfer) {
                        gameState.playerScore -= totalCost;
                        gameState.roundWinnings += amount;
                        gameState.transferUsedThisHour = true;
                        localStorage.setItem(`pordgesdFelTransfer_${gameState.puzzleHourId}`, 'true');

                        updateHostMessage(`Sikeres Ã¡tutalÃ¡s! <strong>${amount.toLocaleString('hu-HU')} Ft</strong> hozzÃ¡adva a kÃ¶rÃ¶s pÃ©nzedhez.`, true);
                        saveWeeklyScore(gameState.playerScore);
                        updateUI();
                    }

                } catch (err) {
                    updateHostMessage("Az Ã¡tutalÃ¡s megszakÃ­tva.");
                    updateUI();
                }
            }

            function handleDoubleOrNothing() {
                if (gameState.roundWinnings <= 0) {
                    updateHostMessage("DUPLA VAGY SEMMI, de nincs mit kockÃ¡ztatni. PÃ¶rgess tovÃ¡bb!", true);
                    endTurn();
                    return;
                }
                gameState.isDoubleOrNothingTurn = true;
                updateHostMessage(getRandomMessage('double_or_nothing_prompt', { points: gameState.roundWinnings.toLocaleString('hu-HU') }), true);
                updateUI();
            }

            function handleLetterGuess(letter) {
                if (gameState.inMainPrizeSelection) {
                    handleMainPrizeLetterSelection(letter);
                    return;
                }

                if (document.querySelector(`#alphabet-panel .alphabet-key[data-letter="${letter}"]`).disabled) return;
                
                const isVowel = VOWELS.includes(letter);
                
                if (gameState.isDoubleOrNothingTurn) {
                    if (isVowel) return; 
                    handleDoubleOrNothingGuess(letter);
                    return;
                }

                if (!isVowel && !gameState.awaitingConsonant) return;
                if (isVowel && gameState.awaitingConsonant) return;

                if (isVowel) {
                    if (gameState.vowelsPurchasedThisRound >= 10) {
                        alert("Ebben a feladvÃ¡nyban mÃ¡r nem vehetsz tÃ¶bb magÃ¡nhangzÃ³t!");
                        return;
                    }
                    const cost = getCurrentVowelCost();
                    if (gameState.hasFreeVowel) {
                        gameState.hasFreeVowel = false;
                        updateHostMessage("FelhasznÃ¡ltad az ingyen pÃ¶rgetett magÃ¡nhangzÃ³t!", true);
                    } else {
                        if(gameState.roundWinnings < cost) {
                             alert(`Nincs elÃ©g pÃ©nzed a magÃ¡nhangzÃ³ra! (${cost} Ft)`);
                             return;
                        }
                        gameState.roundWinnings -= cost;
                        gameState.vowelsPurchasedThisRound++;
                    }
                }
                
                gameState.guessedLetters.push(letter);
                
                const currentPuzzle = allPuzzles[hourlyPuzzleIndices[gameState.currentRound - 1]].puzzle.toUpperCase();
                const foundCount = (currentPuzzle.match(new RegExp(letter, "g")) || []).length;

                if (foundCount > 0) {
                    if (!isVowel) gameState.consecutiveWrongConsonants = 0;
                    revealAndCalculate(letter, isVowel, foundCount);
                } else {
                    if (!isVowel) {
                        gameState.consecutiveWrongConsonants++;
                        showAutoHint();
                    }
                    updateHostMessage(getRandomMessage('wrong_letter'));
                    endTurn();
                }
            }

             async function handleDoubleOrNothingGuess(letter) {
                gameState.guessedLetters.push(letter);
                const currentPuzzle = allPuzzles[hourlyPuzzleIndices[gameState.currentRound - 1]].puzzle.toUpperCase();
                const foundCount = (currentPuzzle.match(new RegExp(letter, "g")) || []).length;

                if (foundCount > 0) {
                    gameState.consecutiveWrongConsonants = 0;
                    gameState.roundWinnings *= 2;
                    updateHostMessage(getRandomMessage('double_win', { points: gameState.roundWinnings.toLocaleString('hu-HU') }), true);
                    await revealAndCalculate(letter, false, foundCount, true);
                } else {
                    gameState.consecutiveWrongConsonants++;
                    showAutoHint();
                    gameState.roundWinnings = 0;
                    updateHostMessage(getRandomMessage('double_lose'), true);
                    endTurn();
                }
            }
            async function revealAndCalculate(letter, isVowel, foundCount, skipEarnings = false){
                wheelCenterButton.disabled = true;
                [solveButton, solveButtonDesktop].forEach(btn => btn.disabled = true);

                const tilesToReveal = document.querySelectorAll(`.puzzle-tile[data-letter="${letter}"]:not(.revealed)`);
                
                if (!skipEarnings) {
                    tilesToReveal.forEach(tile => {
                        const frontFace = tile.querySelector('.tile-front');
                        if (frontFace) frontFace.classList.add('flashing');
                    });
                    await new Promise(resolve => setTimeout(resolve, 1200));
                    tilesToReveal.forEach(tile => {
                        const frontFace = tile.querySelector('.tile-front');
                        if (frontFace) frontFace.classList.remove('flashing');
                    });
                }
                
                for (const tile of tilesToReveal) {
                    tile.classList.add('revealed');
                    await new Promise(resolve => setTimeout(resolve, 150));
                }

                if (!skipEarnings) {
                    if (isVowel) {
                        updateHostMessage(getRandomMessage('correct_vowel', {count: foundCount}));
                    } else {
                        let earnings = foundCount * gameState.currentSpinValue;
                        if(isPrizeActive('three_hit_boost')) earnings *= 2;
                        if(gameState.isCategoryBonusActive) {
                            earnings *=2;
                            gameState.isCategoryBonusActive = false;
                        }
                        gameState.roundWinnings += earnings;
                        
                        if (earnings >= HUGE_WIN_THRESHOLD) {
                            updateHostMessage(getRandomMessage('huge_win_consonant', {count: foundCount, earnings: earnings.toLocaleString('hu-HU')}));
                        } else {
                            updateHostMessage(getRandomMessage('correct_consonant', {count: foundCount, earnings: earnings.toLocaleString('hu-HU')}));
                        }
                    }
                }

                if (document.querySelectorAll('.puzzle-tile[data-letter]').length === document.querySelectorAll('.puzzle-tile.revealed').length) {
                    setTimeout(() => solvePuzzle(true), 1000);
                } else {
                    checkAllConsonantsGuessed();
                    endTurn();
                }
            }
            function gameOver(customMessage = '') {
                gameState.gameInProgress = false;
                saveWeeklyScore(gameState.playerScore);

                if (isSunday && gameState.playerScore >= MILLIONAIRE_THRESHOLD) {
                    const currentWeekId = getWeekNumber(new Date());
                    const [year, weekStr] = currentWeekId.split('-W');
                    let week = parseInt(weekStr);
                    let nextWeek = week + 1;
                    let nextYear = parseInt(year);
                    if (nextWeek > 52) { nextWeek = 1; nextYear++; }
                    const nextWeekId = `${nextYear}-W${nextWeek.toString().padStart(2, '0')}`;
                    localStorage.setItem('millionaireUntilWeekId', nextWeekId);
                    updateHostMessage(`GratulÃ¡lok, <strong>${gameState.playerScore.toLocaleString('hu-HU')}&nbsp;Ft</strong>-tal te lettÃ©l a <strong>HÃ©t Milliomosa!</strong>`, true);
                } else {
                    const finalMessage = customMessage || getRandomMessage('game_over', {score: gameState.playerScore.toLocaleString('hu-HU')});
                    updateHostMessage(finalMessage, true);
                }
                 
                localStorage.setItem('lastPlayedHourId', gameState.puzzleHourId.toString());
                newGameButton.style.display = 'block';
                wheelCenterButton.style.display = 'none';
                [solveButton, solveButtonDesktop, nyero21Button, nyero21ButtonDesktop, transferButton, transferButtonDesktop, lottoButton, lottoButtonDesktop].forEach(btn => btn.style.display = 'none');
                updateUI();
            }
            function endTurn() {
                gameState.currentSpinValue = null;
                gameState.awaitingConsonant = false;
                gameState.isDoubleOrNothingTurn = false;
                
                setTimeout(() => {
                    if (gameState.gameInProgress && document.querySelectorAll('.puzzle-tile[data-letter]').length !== document.querySelectorAll('.puzzle-tile.revealed').length) {
                         if (!gameState.noMoreConsonants) {
                           updateHostMessage(getRandomMessage('turn_end'));
                        } else {
                           updateHostMessage(getRandomMessage('no_more_consonants'), true);
                        }
                    }
                    updateUI();
                }, 1500); 
            }
            async function promptForBet() {
                let bet = null;
                while (bet === null) {
                    try {
                        const rawBet = await showModal({
                            title: 'PrÃ©mium VasÃ¡rnap TÃ©t',
                            text: `A Heti KasszÃ¡ban: <strong>${gameState.playerScore.toLocaleString('hu-HU')}&nbsp;Ft</strong>. Mennyi a tÃ©t erre a kÃ¶rre?`,
                            showInput: true, inputType: 'text',
                            confirmText: 'Mehet a tÃ©t!', showCancel: false
                        });
                        
                        if (rawBet === '0000') {
                            openDevMenu();
                            return null;
                        }

                        const betAmount = parseInt(rawBet, 10);
                        if (isNaN(betAmount) || betAmount <= 0) {
                            alert("KÃ©rlek, Ã©rvÃ©nyes, nullÃ¡nÃ¡l nagyobb szÃ¡mot adj meg!");
                        } else if (betAmount > gameState.playerScore) {
                            alert("Nincs elÃ©g pÃ©nz a kasszÃ¡ban ekkora tÃ©thez!");
                        } else {
                            bet = betAmount;
                        }
                    } catch {
                         alert("A tÃ©t megadÃ¡sa kÃ¶telezÅ a folytatÃ¡shoz!");
                    }
                }
                return bet;
            }
            
            function startNewRound() {
                gameState.isCategoryBonusActive = false;
                gameState.hasBankruptProtection = false;
                gameState.halverAmountLostThisRound = 0;
                gameState.hasFreeSolveAttempt = false;
                gameState.isSolveBonusDoubled = false;
                gameState.roundWinnings = 0;
                gameState.noMoreConsonants = false;
                gameState.currentBet = 0;
                gameState.guessedLetters = [];
                gameState.consecutiveWrongConsonants = 0;
                gameState.vowelsPurchasedThisRound = 0;
                autoHintsContainer.innerHTML = '';
                autoHintsContainer.style.display = 'none';
                
                setupRound();
            }

            async function setupRound() {
                 if (gameState.currentRound > gameState.totalRounds) {
                     handleEndOfHour();
                     return;
                }
                
                const puzzleData = allPuzzles[hourlyPuzzleIndices[gameState.currentRound - 1]];
                
                if (isPrizeActive('lotto_bajnok')) {
                    puzzleCategory.classList.add('golden');
                    updateHostMessage(getRandomMessage('start_golden_round'), true);
                } else {
                    puzzleCategory.classList.remove('golden');
                }
                
                if(isPrizeActive('two_hit_reveal') && puzzleData.puzzle.replace(/\s/g, '').length > 8) {
                    let consonants = [...new Set(puzzleData.puzzle.split('').filter(c => !VOWELS.includes(c) && c !== ' '))];
                    for(let i = 0; i < 2 && consonants.length > 0; i++) {
                        const randIndex = Math.floor(Math.random() * consonants.length);
                        const letterToReveal = consonants.splice(randIndex, 1)[0];
                        gameState.guessedLetters.push(letterToReveal);
                    }
                }

                if(isSunday){
                    mainPrizeProgress.style.display = 'none';
                    document.getElementById('hourly-hud').style.display = 'none';
                    document.getElementById('round-winnings-hud').style.flexBasis = '100%';

                    const bet = await promptForBet();
                    if (bet === null) return;
                    gameState.currentBet = bet;
                    gameState.playerScore -= bet;
                }
                
                drawWheel(gameState.currentRound);
                
                puzzleCategory.textContent = puzzleData.category;
                
                if (gameState.currentRound === 1 && !isPrizeActive('lotto_bajnok')) {
                     if (!isSunday && localStorage.getItem('quitHourId') == gameState.puzzleHourId) {
                        updateHostMessage(getRandomMessage('quit_warning'), true);
                     } else {
                        updateHostMessage(getRandomMessage(isSunday ? 'sunday_greeting' : 'start_game'));
                     }
                 } else if(!isPrizeActive('lotto_bajnok')) {
                    updateHostMessage(getRandomMessage('start_round', { round: gameState.currentRound }));
                 }

                setupPuzzleBoard(puzzleBoard, puzzleData);
                createAlphabetPanel();
                gameState.guessedLetters.forEach(letter => {
                     document.querySelectorAll(`.puzzle-tile[data-letter="${letter}"]`).forEach(tile => tile.classList.add('revealed'));
                });
                updateUI();
            }

             async function handleEndOfHour() {
                updateHostMessage("Fantasztikus jÃ¡tÃ©k volt, mind a 10 feladvÃ¡nyt megfejtetted!", true);

                const canPlay = gameState.hourlyWinnings >= MAIN_PRIZE_THRESHOLD;
                let neededToTopUp = 0;
                let canTopUp = false;
                
                if (!canPlay) {
                    neededToTopUp = MAIN_PRIZE_THRESHOLD - gameState.hourlyWinnings;
                    canTopUp = gameState.playerScore >= neededToTopUp;
                }
                
                try {
                    if (canPlay) {
                        const play = await showModal({
                            title: 'FÅdÃ­j JÃ¡tÃ©k LehetÅsÃ©g',
                            text: `GratulÃ¡lok, jÃ¡tszhatsz a FÅdÃ­jÃ©rt! KockÃ¡ztatod a menetben gyÅ±jtÃ¶tt <strong>${gameState.hourlyWinnings.toLocaleString('hu-HU')} Ft</strong>-ot a duplÃ¡jÃ¡Ã©rt?`,
                            confirmText: 'KockÃ¡ztatok!', cancelText: 'InkÃ¡bb nem'
                        });
                        if (play) {
                             startMainPrizeGame(false);
                        } else { 
                            gameState.playerScore += gameState.hourlyWinnings;
                            gameState.hourlyWinnings = 0;
                            saveWeeklyScore(gameState.playerScore);
                            gameOver(`Okos dÃ¶ntÃ©s! A nyeremÃ©nyed mÃ¡r a zsebedben van.`); 
                        }
                    } else if (canTopUp) {
                        const topUp = await showModal({
                            title: 'FÅdÃ­j JÃ¡tÃ©k - KipÃ³tlÃ¡s',
                            text: `Sajnos nem gyÅ±lt Ã¶ssze a szÃ¼ksÃ©ges <strong>${MAIN_PRIZE_THRESHOLD.toLocaleString('hu-HU')} Ft</strong>. <br><br>SzeretnÃ©d a hiÃ¡nyzÃ³ <strong>${neededToTopUp.toLocaleString('hu-HU')} Ft</strong>-ot kipÃ³tolni a teljes vagyonodbÃ³l, hogy jÃ¡tszhass a FÅdÃ­jÃ©rt?`,
                            confirmText: 'Igen, pÃ³tolom!', cancelText: 'Nem, kÃ¶szÃ¶nÃ¶m'
                        });
                        if (topUp) {
                            gameState.playerScore -= neededToTopUp;
                            gameState.hourlyWinnings = MAIN_PRIZE_THRESHOLD;
                            saveWeeklyScore(gameState.playerScore);
                            updateUI();
                            startMainPrizeGame(false);
                        } else { 
                            gameState.playerScore += gameState.hourlyWinnings;
                            gameState.hourlyWinnings = 0;
                            saveWeeklyScore(gameState.playerScore);
                            gameOver(`Rendben van! A nyeremÃ©nyed mÃ¡r biztos helyen van.`); 
                        }
                    } else {
                        await showModal({
                            title: 'JÃ¡tÃ©k VÃ©ge',
                            text: `Sajnos nem gyÅ±lt Ã¶ssze a FÅdÃ­j JÃ¡tÃ©khoz szÃ¼ksÃ©ges Ã¶sszeg, Ã©s a teljes vagyonodbÃ³l sem tudod kipÃ³tolni. GratulÃ¡lok az eddigi nyeremÃ©nyedhez!`,
                            showCancel: false
                        });
                        gameState.playerScore += gameState.hourlyWinnings;
                        gameState.hourlyWinnings = 0;
                        saveWeeklyScore(gameState.playerScore);
                        gameOver();
                    }
                } catch { 
                    gameState.playerScore += gameState.hourlyWinnings;
                    gameState.hourlyWinnings = 0;
                    saveWeeklyScore(gameState.playerScore);
                    gameOver(`DÃ¶ntÃ©s nÃ©lkÃ¼l a nyeremÃ©nyed mÃ¡r a zsebedben van. GratulÃ¡lok!`);
                }
            }
            
            function getEndOfSundayTimestamp() {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const daysUntilSunday = (7 - dayOfWeek) % 7;
                const endOfSunday = new Date(now);
                endOfSunday.setDate(now.getDate() + daysUntilSunday);
                endOfSunday.setHours(23, 59, 59, 999);
                return endOfSunday.getTime();
            }

            function getActiveBonuses() {
                let bonuses = JSON.parse(localStorage.getItem('pordgesdFelActiveBonuses') || '[]');
                const activeBonuses = bonuses.filter(bonus => bonus.expiry > Date.now());
                if (bonuses.length !== activeBonuses.length) {
                    localStorage.setItem('pordgesdFelActiveBonuses', JSON.stringify(activeBonuses));
                }
                return activeBonuses;
            }

            function getPrizeInventory() {
                const currentWeekId = getWeekNumber(new Date());
                let inventory = JSON.parse(localStorage.getItem('pordgesdFelPrizeInventory') || '[]');
                const validInventory = inventory.filter(prize => prize.weekId === currentWeekId);
                if(inventory.length !== validInventory.length) savePrizeInventory(validInventory);
                return validInventory;
            }

            function savePrizeInventory(inventory) {
                localStorage.setItem('pordgesdFelPrizeInventory', JSON.stringify(inventory));
            }
            
            function isPrizeActive(prizeId) {
                return getActiveBonuses().some(bonus => bonus.id === prizeId);
            }

            function activatePrize(prizeIndex) {
                let inventory = getPrizeInventory();
                const prize = inventory.splice(prizeIndex, 1)[0];
                if(!prize) return;

                let activeBonuses = getActiveBonuses();
                let expiry = (prize.duration === '24h') ? Date.now() + 24 * 60 * 60 * 1000 : getEndOfSundayTimestamp();
                activeBonuses.push({ ...prize, expiry: expiry });
                
                if(prize.id === 'lotto_bajnok'){
                    gameState.playerScore += 100000;
                    saveWeeklyScore(gameState.playerScore);
                }

                localStorage.setItem('pordgesdFelActiveBonuses', JSON.stringify(activeBonuses));
                savePrizeInventory(inventory);
                alert(`"${prize.name}" bÃ³nusz aktivÃ¡lva!`);
                updateUI();
                showPrizeChest();
            }

            function showActiveBonuses() {
                activeBonusesModal.classList.add('visible');
                const bonuses = getActiveBonuses();
                activeBonusesList.innerHTML = bonuses.length === 0 ? '<li>Jelenleg nincsenek aktÃ­v bÃ³nuszaid.</li>' : bonuses.map(bonus => {
                    const expiryDate = new Date(bonus.expiry);
                    return `<li><span class="bonus-name">${bonus.name}</span><span class="bonus-expiry">LejÃ¡r: ${expiryDate.toLocaleString('hu-HU')}</span></li>`;
                }).join('');
            }
            
            function showPrizeChest() {
                prizeChestModal.classList.add('visible');
                const inventory = getPrizeInventory();
                prizeChestList.innerHTML = inventory.length === 0 ? '<li>Jelenleg nincsenek aktivÃ¡lhatÃ³ nyeremÃ©nyeid a lÃ¡dÃ¡ban.</li>' : inventory.map((prize, index) => `
                    <li>
                        <div class="prize-info">
                            <span class="bonus-name">${prize.name}</span>
                            <span class="prize-expiry">${prize.description}</span>
                        </div>
                        <button class="modal-btn activate-prize-btn" data-prize-index="${index}">AktivÃ¡lÃ¡s</button>
                    </li>
                `).join('');
                
                document.querySelectorAll('.activate-prize-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => activatePrize(parseInt(e.target.dataset.prizeIndex, 10)));
                });
            }

            function getDailyLottoNumbers(date = new Date()) {
                const dateStr = getFormattedDate(date);
                const seed = parseInt(dateStr.replace(/-/g, ''));
                const random = seededRandom(seed);
                const generatedNumbers = [];
                const available = Array.from({length: LOTTO_NUM_RANGE}, (_, i) => i + 1);
                for(let i = 0; i < 5; i++){
                    const randIndex = Math.floor(random() * available.length);
                    generatedNumbers.push(available.splice(randIndex, 1)[0]);
                }
                return generatedNumbers.sort((a,b) => a-b);
            }

            function launchLotto(isDevTest = false) {
                isDevModeActive = isDevTest;
                lottoInfoArea.style.display = 'block';
                lottoBettingArea.style.display = 'none';
                lottoModal.classList.add('visible');
                lottoModal.querySelector('.dev-mode-indicator').style.display = isDevModeActive ? 'block' : 'none';

                const now = new Date();
                const hour = now.getHours();
                const todayStr = getFormattedDate(now);
                const todaysTickets = isDevTest ? [] : JSON.parse(localStorage.getItem(`lottoTickets_${todayStr}`) || '[]');
                
                let winningNumbers = null;
                let drawingDate = null;

                if (hour >= 19) {
                    winningNumbers = getDailyLottoNumbers();
                    drawingDate = now;
                } else { 
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    winningNumbers = getDailyLottoNumbers(yesterday);
                    drawingDate = yesterday;
                }

                lottoDrawingContainer.style.display = winningNumbers ? 'block' : 'none';
                if(winningNumbers) displayWinningNumbers(drawingDate, winningNumbers);
                
                lottoSubmittedTickets.innerHTML = '';
                if(todaysTickets.length > 0) displaySubmittedTickets(todaysTickets, (hour >= 19) ? winningNumbers : null);

                const canBuy = hour < 19;
                lottoBuyTicketBtn.style.display = canBuy || isDevTest ? 'inline-flex' : 'none';
                if (canBuy || isDevTest) {
                    const ticketsLeft = MAX_LOTTO_TICKETS_PER_DAY - todaysTickets.length;
                    lottoStatusText.textContent = isDevModeActive ? "TESZT MÃD: KorlÃ¡tlan szelvÃ©ny." : (ticketsLeft > 0 ? `Ma mÃ©g ${ticketsLeft} szelvÃ©nyt adhatsz fel. A sorsolÃ¡s este 7-kor!` : "MÃ¡ra elÃ©rted a maximÃ¡lis szelvÃ©nyek szÃ¡mÃ¡t.");
                    if (!isDevModeActive && ticketsLeft <= 0) lottoBuyTicketBtn.style.display = 'none';
                } else {
                    lottoStatusText.textContent = "A mai fogadÃ¡s lezÃ¡rult. Holnap Ãºjra prÃ³bÃ¡lkozhatsz!";
                }
                
                if(hour >= 19 && !isDevModeActive) checkForLottoWinnings();
            }

            function showLottoBettingView() {
                if (!isDevModeActive && (!gameState || !gameState.hasFreeLottoTicket)) {
                    const todayStr = getFormattedDate(new Date());
                    const todaysTickets = JSON.parse(localStorage.getItem(`lottoTickets_${todayStr}`) || '[]');
                    if (todaysTickets.length >= MAX_LOTTO_TICKETS_PER_DAY) {
                        alert("MÃ¡ra elÃ©rted a maximÃ¡lis szelvÃ©nyek szÃ¡mÃ¡t.");
                        return;
                    }
                    if (!gameState || gameState.playerScore < LOTTO_COST) {
                        alert(`Nincs elÃ©g zsetonod egy szelvÃ©ny vÃ¡sÃ¡rlÃ¡sÃ¡hoz! (${LOTTO_COST.toLocaleString('hu-HU')} Ft)`);
                        return;
                    }
                }
                lottoCostText.innerHTML = (isDevModeActive || (gameState && gameState.hasFreeLottoTicket)) ? "A szelvÃ©ny <strong>INGYENES</strong>" : `A szelvÃ©ny Ã¡ra: <strong>${LOTTO_COST.toLocaleString('hu-HU')} Ft</strong>`;
                lottoInfoArea.style.display = 'none';
                lottoBettingArea.style.display = 'block';
                resetLottoSelection();
                buildLottoGrid();
            }
            
            function displayWinningNumbers(dateObj, numbers) {
                 const weekdays = ["vasÃ¡rnap", "hÃ©tfÅ", "kedd", "szerda", "csÃ¼tÃ¶rtÃ¶k", "pÃ©ntek", "szombat"];
                 lottoDrawingDate.textContent = `A ${getFormattedDate(dateObj)} (${weekdays[dateObj.getDay()]}) napi nyerÅszÃ¡mok:`;
                 lottoWinningNumbers.innerHTML = numbers.map(n => `<div class="lotto-ball">${n}</div>`).join('');
            }
            
            function displaySubmittedTickets(tickets, winningNumbers) {
                const header = document.createElement('h4');
                header.textContent = 'Mai szelvÃ©nyeid:';
                lottoSubmittedTickets.appendChild(header);

                tickets.forEach((ticket, index) => {
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'submitted-ticket-container';
                    const ticketNumbersHTML = ticket.numbers.map(num => `<div class="submitted-ticket-number ${winningNumbers && winningNumbers.includes(num) ? 'match' : ''}">${num}</div>`).join('');
                    ticketDiv.innerHTML = `<div class="submitted-ticket-header">${index + 1}. szelvÃ©ny (${ticket.timestamp})</div><div class="submitted-ticket-numbers">${ticketNumbersHTML}</div>`;
                    lottoSubmittedTickets.appendChild(ticketDiv);
                });
            }

            function buildLottoGrid() {
                lottoGrid.innerHTML = '';
                for (let i = 1; i <= LOTTO_NUM_RANGE; i++) {
                    const numEl = document.createElement('div');
                    numEl.className = 'lotto-number';
                    numEl.textContent = i;
                    numEl.dataset.number = i;
                    numEl.addEventListener('click', () => handleLottoNumberSelect(i));
                    lottoGrid.appendChild(numEl);
                }
            }
            
            function handleLottoNumberSelect(num) {
                const numEl = lottoGrid.querySelector(`[data-number='${num}']`);
                const index = lottoState.selectedNumbers.indexOf(num);
                if (index > -1) {
                    lottoState.selectedNumbers.splice(index, 1);
                    numEl.classList.remove('selected');
                } else if (lottoState.selectedNumbers.length < 5) {
                    lottoState.selectedNumbers.push(num);
                    numEl.classList.add('selected');
                }
                lottoSelectedDisplay.textContent = lottoState.selectedNumbers.length > 0 ? `NyerÅszÃ¡maid: ${lottoState.selectedNumbers.sort((a,b)=>a-b).join(', ')}` : 'NyerÅszÃ¡maid: -';
                lottoSubmitBtn.disabled = lottoState.selectedNumbers.length !== 5;
            }

            function resetLottoSelection() {
                lottoState.selectedNumbers = [];
                lottoSelectedDisplay.textContent = `NyerÅszÃ¡maid: -`;
                if(lottoGrid.innerHTML !== '') document.querySelectorAll('.lotto-number.selected').forEach(el => el.classList.remove('selected'));
                lottoSubmitBtn.disabled = true;
            }
            
            function submitLottoTicket() {
                if (lottoState.selectedNumbers.length !== 5) return alert("KÃ©rlek, vÃ¡lassz ki 5 szÃ¡mot!");
                
                if (isDevModeActive) {
                    alert("TESZT MÃD: SzelvÃ©ny feladva tÃ©t nÃ©lkÃ¼l!");
                } else if (gameState.hasFreeLottoTicket) {
                    gameState.hasFreeLottoTicket = false;
                    alert("Ingyenes szelvÃ©ny feladva! Sok szerencsÃ©t!");
                } else {
                    gameState.playerScore -= LOTTO_COST;
                    saveWeeklyScore(gameState.playerScore);
                    alert("SzelvÃ©ny feladva! Sok szerencsÃ©t!");
                }
                updateUI();
                
                if (!isDevModeActive) {
                    const todayStr = getFormattedDate(new Date());
                    const todaysTickets = JSON.parse(localStorage.getItem(`lottoTickets_${todayStr}`) || '[]');
                    todaysTickets.push({ numbers: lottoState.selectedNumbers.sort((a,b) => a-b), timestamp: new Date().toLocaleTimeString('hu-HU') });
                    localStorage.setItem(`lottoTickets_${todayStr}`, JSON.stringify(todaysTickets));
                }
                
                lottoInfoArea.style.display = 'block';
                lottoBettingArea.style.display = 'none';
                launchLotto(isDevModeActive);
            }
            
            function checkForLottoWinnings() {
                const todayStr = getFormattedDate(new Date());
                const checkedKey = `lottoWinningsChecked_${todayStr}`;
                if (localStorage.getItem(checkedKey)) return;

                const todaysTickets = JSON.parse(localStorage.getItem(`lottoTickets_${todayStr}`) || '[]');
                if (todaysTickets.length === 0) {
                     localStorage.setItem(checkedKey, 'true');
                     return;
                }

                const winningNumbers = getDailyLottoNumbers();
                const currentWeekId = getWeekNumber(new Date());
                const prizesWon = todaysTickets.map(ticket => {
                    const matches = ticket.numbers.filter(num => winningNumbers.includes(num)).length;
                    return LOTTO_PRIZES[matches] ? {...LOTTO_PRIZES[matches], weekId: currentWeekId} : null;
                }).filter(Boolean);

                if (prizesWon.length > 0) {
                    let inventory = getPrizeInventory();
                    inventory.push(...prizesWon);
                    savePrizeInventory(inventory);
                    alert(`GratulÃ¡lok, nyertÃ©l a mai lottÃ³n! A jutalmad a NyeremÃ©nylÃ¡dÃ¡ba kerÃ¼lt, ahol aktivÃ¡lhatod.`);
                    updatePrizeChestHud();
                }
                localStorage.setItem(checkedKey, 'true');
            }
            
            function initializeGame() {
                if(gameState && gameState.gameInProgress) return;
                resetGameState(true);
                document.body.classList.toggle('sunday-special', isSunday);
                mainHudLabel.textContent = isSunday ? "Heti Kassza" : "Ãsszes Zseton";

                const hourId = Math.floor(Date.now() / (1000 * 60 * 60));
                hourlyPuzzleIndices = getHourlyPuzzles(seededRandom(hourId));
                gameState.transferUsedThisHour = localStorage.getItem(`pordgesdFelTransfer_${hourId}`) === 'true';
                
                const currentWeekId = getWeekNumber(new Date());
                const millionaireWeek = localStorage.getItem('millionaireUntilWeekId');
                 if (millionaireWeek && millionaireWeek === currentWeekId) {
                    gameState.isMillionaire = true;
                    document.body.classList.add('millionaire-active');
                } else {
                    localStorage.removeItem('millionaireUntilWeekId');
                }

                gameState.puzzleHourId = hourId;
                gameState.gameInProgress = true;
                
                 if(isSunday && gameState.playerScore <= 0){
                    puzzleBoard.innerHTML = '<div style="text-align:center; font-size: 1.2rem; color: white; padding: 2rem; line-height: 1.5;">Nincs pÃ©nz a Heti KasszÃ¡ban a vasÃ¡rnapi jÃ¡tÃ©khoz.<br>Gyere vissza hÃ©tkÃ¶znap gyÅ±jteni!</div>';
                    alphabetPanel.innerHTML = '';
                    gameState.gameInProgress = false;
                    newGameButton.style.display = 'block';
                    wheelCenterButton.style.display = 'none';
                    [solveButton, solveButtonDesktop, nyero21Button, nyero21ButtonDesktop, transferButton, transferButtonDesktop, lottoButton, lottoButtonDesktop].forEach(btn => btn.style.display = 'none');
                    updateUI();
                    return;
                 }
                
                newGameButton.style.display = 'none';
                skipErrorBtn.style.display = 'none';
                wheelCenterButton.style.display = 'flex';
                solveButton.style.display = 'inline-flex';
                nyero21Button.style.display = 'inline-flex';
                transferButton.style.display = 'inline-flex';
                lottoButton.style.display = 'inline-flex';
                setupRound();
            }

            window.addEventListener('beforeunload', () => {
                if (gameState && gameState.gameInProgress) {
                    if (localStorage.getItem('quitHourId') != gameState.puzzleHourId) { 
                        localStorage.setItem('quitHourId', gameState.puzzleHourId.toString());
                    }
                    localStorage.setItem('lastPlayedHourId', gameState.puzzleHourId.toString());
                }
            });
            
            logoContainer.addEventListener('click', () => {
                const code = prompt("FejlesztÅi kÃ³d:");
                if (code === '0000') {
                    if (!gameState) { 
                        resetGameState(true); 
                        updateUI();
                    }
                    openDevMenu();
                } else if (code) {
                    alert("HibÃ¡s kÃ³d!");
                }
            });
            
            devModalCloseBtn.addEventListener('click', () => devModal.classList.remove('visible'));

            devForceMainPrizeBtn.addEventListener('click', () => {
                if (!gameState) resetGameState(true);
                devModal.classList.remove('visible');
                startMainPrizeGame(true);
            });
            devTestLottoBtn.addEventListener('click', () => {
                if (!gameState) resetGameState(true);
                devModal.classList.remove('visible');
                launchLotto(true);
            });
            devTestNyero21Btn.addEventListener('click', () => {
                if (!gameState) resetGameState(true);
                devModal.classList.remove('visible');
                launchNyero21(true);
            });
            
            wheelCenterButton.addEventListener('click', togglePowerMeter);
            newGameButton.addEventListener('click', () => { newGameButton.disabled = true; location.reload(); });
            skipErrorBtn.addEventListener('click', () => {
                gameState.isSpinning = false;
                endTurn();
                skipErrorBtn.style.display = 'none';
            });


            [solveButton, solveButtonDesktop].forEach(btn => btn.addEventListener('click', () => solvePuzzle(false)));
            [transferButton, transferButtonDesktop].forEach(btn => btn.addEventListener('click', handleTransfer));
            [lottoButton, lottoButtonDesktop].forEach(btn => btn.addEventListener('click', () => launchLotto(false)));
            [nyero21Button, nyero21ButtonDesktop].forEach(btn => btn.addEventListener('click', () => launchNyero21(false)));
            
            lottoBuyTicketBtn.addEventListener('click', showLottoBettingView);
            lottoCancelBtn.addEventListener('click', () => {
                lottoModal.classList.remove('visible');
                isDevModeActive = false;
            });
            lottoCancelBetBtn.addEventListener('click', () => {
                lottoBettingArea.style.display = 'none';
                lottoInfoArea.style.display = 'block';
            });
            lottoSubmitBtn.addEventListener('click', submitLottoTicket);
            lottoPrizeHud.addEventListener('click', showActiveBonuses);
            activeBonusesCloseBtn.addEventListener('click', () => activeBonusesModal.classList.remove('visible'));
            prizeChestHud.addEventListener('click', showPrizeChest);
            prizeChestCloseBtn.addEventListener('click', () => prizeChestModal.classList.remove('visible'));
            
            mainPrizeSelectConfirmBtn.addEventListener('click', runMainPrizeCountdown);
            mainPrizeConfirmBtn.addEventListener('click', () => {
                 const mainPrizePuzzles = allPuzzles.filter(p => p.category === 'FÅdÃ­j FeladvÃ¡ny');
                 const mainPrizePuzzle = mainPrizePuzzles[gameState.puzzleHourId % mainPrizePuzzles.length];
                 const normalizeText = (text) => text.toUpperCase().replace(/[^A-ZÃÃÃÃÃÅUÃÃÅ°0-9]/g, '');
                 const cleanPuzzle = normalizeText(mainPrizePuzzle.puzzle);
                 const attempt = normalizeText(mainPrizeSolveInput.value);
                 endMainPrizeGame(attempt === cleanPuzzle);
            });
            mainPrizeCloseBtn.addEventListener('click', forceEndMainPrize);


            nyero21StartGameBtn.addEventListener('click', startNyero21);
            nyero21CancelBtn.addEventListener('click', () => {
                nyero21Modal.classList.remove('visible');
                isDevModeActive = false;
            });
            nyero21HitBtn.addEventListener('click', () => {
                const unflippedCard = nyero21CardDeck.querySelector('.nyero21-card:not(.flipped)');
                if (unflippedCard) unflippedCard.dispatchEvent(new Event('click'));
            });
            nyero21StandBtn.addEventListener('click', standNyero21);
            nyero21NewGameBtn.addEventListener('click', () => {
                nyero21GameArea.style.display = 'none';
                nyero21StakingArea.style.display = 'block';
                 nyero21PlaysLeft.textContent = isDevModeActive ? "TESZT MÃD: KorlÃ¡tlan jÃ¡tÃ©k." : `Ebben az Ã³rÃ¡ban mÃ©g ${MINIGAME_PLAYS_PER_HOUR - (gameState ? gameState.nyero21PlaysThisHour : 0)} alkalommal jÃ¡tszhatsz.`;
            });
            nyero21CloseBtn.addEventListener('click', () => {
                nyero21Modal.classList.remove('visible');
                isDevModeActive = false;
            });
            
            initializeGame();
        });
    </script>
</body>
</html>
